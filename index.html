<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mudbrick â€” Free PDF Editor</title>
  <meta name="description" content="Free, open-source PDF editor. No subscription. No dark patterns. Runs entirely in your browser.">

  <!-- Styles -->
  <link rel="stylesheet" href="styles/variables.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">

  <!-- CDN: Google Fonts for signature cursive styles (lazy-loaded) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Dancing+Script&family=Great+Vibes&family=Sacramento&display=swap" rel="stylesheet">

  <!-- CDN: pdf-lib (UMD, sets window.PDFLib) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- CDN: Fabric.js 5.3 (IIFE, sets window.fabric) -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <!-- Favicon (brick emoji) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>">
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Welcome Screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="welcome-screen">
    <div class="welcome-content">
      <h1>ðŸ§± Mudbrick</h1>
      <p class="tagline">Free PDF editor. No subscription. No dark patterns.</p>

      <div id="drop-zone">
        <div class="drop-icon" data-icon="file" data-icon-size="48"></div>
        <div class="drop-text">Drop a PDF or image here</div>
        <div class="drop-or">or</div>
        <button class="btn-primary" id="open-file-btn">Open File</button>
        <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.bmp,.tiff" hidden>
      </div>

      <div class="welcome-features">
        <span>View &amp; Navigate</span>
        <span>Annotate &amp; Draw</span>
        <span>Merge &amp; Split</span>
        <span>Fill Forms</span>
        <span>Visual Cover</span>
        <span>Watermark</span>
        <span>100% Client-Side</span>
      </div>

      <!-- Recent Files -->
      <div id="recent-files" class="recent-files hidden">
        <div class="recent-files-header">
          <span data-icon="clock" data-icon-size="14"></span>
          <span>Recent Files</span>
          <button id="btn-clear-recent" class="recent-clear-btn" title="Clear recent files">&times;</button>
        </div>
        <ul id="recent-files-list" class="recent-files-list"></ul>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• App Shell â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app" class="hidden">

    <!-- â”€â”€ Title Bar â”€â”€ -->
    <div id="titlebar">
      <div class="brand">
        <div class="brand-icon">M</div>
        <span class="brand-name">Mudbrick</span>
      </div>
      <div class="menu-items">
        <button class="menu-item">File</button>
        <button class="menu-item">Edit</button>
        <button class="menu-item">View</button>
        <button class="menu-item">Insert</button>
        <button class="menu-item">Tools</button>
        <button class="menu-item">Help</button>
      </div>
      <span id="status-filename" class="title-filename">No file loaded</span>
      <div class="titlebar-right">
        <button id="btn-dark-mode" class="titlebar-btn" title="Toggle Dark Mode" data-icon="moon"></button>
      </div>
    </div>

    <!-- â”€â”€ Ribbon Tab Strip â”€â”€ -->
    <div id="ribbon-tabs">
      <button class="ribbon-tab active" data-ribbon="home">Home</button>
      <button class="ribbon-tab" data-ribbon="edit">Edit</button>
      <button class="ribbon-tab" data-ribbon="annotate">Annotate</button>
      <button class="ribbon-tab" data-ribbon="forms">Forms</button>
      <button class="ribbon-tab" data-ribbon="security">Security</button>
      <button class="ribbon-tab" data-ribbon="tools">Tools</button>
    </div>

    <!-- â”€â”€ Ribbon Panel (contextual toolbar) â”€â”€ -->
    <div id="ribbon-panel">

      <!-- Ribbon: Home (default) -->
      <div class="ribbon-content active" id="ribbon-home">
        <!-- File group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-open" class="ribbon-btn ribbon-btn-lg" title="Open PDF (Ctrl+O)">
              <span class="ribbon-icon" data-icon="folder-open" data-icon-size="20"></span>
              <span>Open</span>
            </button>
            <button id="btn-export" class="ribbon-btn ribbon-btn-lg" title="Export (Ctrl+S)" disabled>
              <span class="ribbon-icon" data-icon="save" data-icon-size="20"></span>
              <span>Export</span>
            </button>
          </div>
          <div class="ribbon-group-label">File</div>
        </div>

        <!-- Undo/Redo group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-undo" class="ribbon-btn" title="Undo (Ctrl+Z)" disabled>
              <span class="ribbon-icon" data-icon="undo"></span>
              <span>Undo</span>
            </button>
            <button id="btn-redo" class="ribbon-btn" title="Redo (Ctrl+Y)" disabled>
              <span class="ribbon-icon" data-icon="redo"></span>
              <span>Redo</span>
            </button>
          </div>
          <div class="ribbon-group-label">History</div>
        </div>

        <!-- Organize group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-merge" class="ribbon-btn ribbon-btn-lg" title="Merge PDFs" disabled>
              <span class="ribbon-icon" data-icon="link" data-icon-size="20"></span>
              <span>Merge</span>
            </button>
            <button id="btn-split" class="ribbon-btn ribbon-btn-lg" title="Split PDF" disabled>
              <span class="ribbon-icon" data-icon="scissors" data-icon-size="20"></span>
              <span>Split</span>
            </button>
          </div>
          <div class="ribbon-group-label">Organize</div>
        </div>

        <!-- Annotate Quick group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-text" class="ribbon-btn tool-btn" data-tool="text" title="Text (T)" disabled>
              <span class="ribbon-icon" data-icon="type"></span>
              <span>Text</span>
            </button>
            <button id="btn-highlight" class="ribbon-btn tool-btn" data-tool="highlight" title="Highlight" disabled>
              <span class="ribbon-icon" data-icon="highlighter"></span>
              <span>Highlight</span>
            </button>
            <button id="btn-underline" class="ribbon-btn tool-btn" data-tool="underline" title="Underline" disabled>
              <span class="ribbon-icon" data-icon="underline"></span>
              <span>Underline</span>
            </button>
            <button id="btn-strikethrough" class="ribbon-btn tool-btn" data-tool="strikethrough" title="Strikethrough" disabled>
              <span class="ribbon-icon" data-icon="strikethrough"></span>
              <span>Strike</span>
            </button>
            <button id="btn-draw" class="ribbon-btn tool-btn" data-tool="draw" title="Draw (D)" disabled>
              <span class="ribbon-icon" data-icon="pencil"></span>
              <span>Draw</span>
            </button>
            <button id="btn-stamp" class="ribbon-btn tool-btn" data-tool="stamp" title="Stamp" disabled>
              <span class="ribbon-icon" data-icon="stamp"></span>
              <span>Stamp</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button id="btn-shape" class="ribbon-btn tool-btn" data-tool="shape" title="Shape" disabled>
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Shape</span>
            </button>
            <button id="btn-cover" class="ribbon-btn tool-btn" data-tool="cover" title="Visual Cover" disabled>
              <span class="ribbon-icon" data-icon="shield"></span>
              <span>Cover</span>
            </button>
            <button id="btn-redact" class="ribbon-btn tool-btn" data-tool="redact" title="Redact" disabled>
              <span class="ribbon-icon" data-icon="shield-off"></span>
              <span>Redact</span>
            </button>
            <button id="btn-insert-image" class="ribbon-btn" title="Insert Image" disabled>
              <span class="ribbon-icon" data-icon="image"></span>
              <span>Image</span>
            </button>
            <button id="btn-signature" class="ribbon-btn" title="Signature" disabled>
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button id="btn-sticky-note" class="ribbon-btn tool-btn" data-tool="sticky-note" title="Sticky Note" disabled>
              <span class="ribbon-icon" data-icon="sticky-note"></span>
              <span>Note</span>
            </button>
            <button id="btn-watermark" class="ribbon-btn" title="Watermark" disabled>
              <span class="ribbon-icon" data-icon="droplet"></span>
              <span>Watermark</span>
            </button>
          </div>
          <div class="ribbon-group-label">Annotate</div>
        </div>

        <!-- View group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-select" class="ribbon-btn tool-btn active" data-tool="select" title="Select (V)">
              <span class="ribbon-icon" data-icon="mouse-pointer"></span>
              <span>Select</span>
            </button>
            <button id="btn-hand" class="ribbon-btn tool-btn" data-tool="hand" title="Hand (H)">
              <span class="ribbon-icon" data-icon="hand"></span>
              <span>Hand</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button id="btn-zoom-out" class="ribbon-btn" title="Zoom Out (-)">
              <span class="ribbon-icon" data-icon="minus"></span>
            </button>
            <button id="btn-zoom-level" class="ribbon-btn" title="Click to reset">100%</button>
            <button id="btn-zoom-in" class="ribbon-btn" title="Zoom In (+)">
              <span class="ribbon-icon" data-icon="plus"></span>
            </button>
            <button id="btn-fit-width" class="ribbon-btn" title="Fit Width">
              <span class="ribbon-icon" data-icon="columns"></span>
            </button>
            <button id="btn-fit-page" class="ribbon-btn" title="Fit Page">
              <span class="ribbon-icon" data-icon="maximize"></span>
            </button>
          </div>
          <div class="ribbon-group-label">View</div>
        </div>
      </div>

      <!-- Ribbon: Edit (hidden by default) -->
      <div class="ribbon-content" id="ribbon-edit">
        <!-- Page group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-insert-blank" class="ribbon-btn ribbon-btn-lg" title="Insert Blank Page" disabled>
              <span class="ribbon-icon" data-icon="file-plus" data-icon-size="20"></span>
              <span>Insert Page</span>
            </button>
            <button id="btn-replace-pages" class="ribbon-btn ribbon-btn-lg" title="Replace Pages" disabled>
              <span class="ribbon-icon" data-icon="replace" data-icon-size="20"></span>
              <span>Replace</span>
            </button>
            <button id="btn-crop-page" class="ribbon-btn ribbon-btn-lg" title="Crop Page" disabled>
              <span class="ribbon-icon" data-icon="crop" data-icon-size="20"></span>
              <span>Crop</span>
            </button>
            <button id="btn-page-labels" class="ribbon-btn ribbon-btn-lg" title="Page Labels" disabled>
              <span class="ribbon-icon" data-icon="tag" data-icon-size="20"></span>
              <span>Labels</span>
            </button>
          </div>
          <div class="ribbon-group-label">Page</div>
        </div>
        <!-- Content group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-edit-text" class="ribbon-btn" title="Edit existing text on this page" disabled>
              <span class="ribbon-icon" data-icon="type" data-icon-size="20"></span>
              <span>Edit Text</span>
            </button>
            <button id="btn-edit-image" class="ribbon-btn" title="Edit images on this page" disabled>
              <span class="ribbon-icon" data-icon="image" data-icon-size="20"></span>
              <span>Edit Images</span>
            </button>
          </div>
          <div class="ribbon-group-label">Content</div>
        </div>
        <!-- Legal group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-bates" class="ribbon-btn ribbon-btn-lg" title="Bates Numbering" disabled>
              <span class="ribbon-icon" data-icon="hash" data-icon-size="20"></span>
              <span>Bates</span>
            </button>
            <button id="btn-headers-footers" class="ribbon-btn ribbon-btn-lg" title="Headers & Footers" disabled>
              <span class="ribbon-icon" data-icon="align-justify" data-icon-size="20"></span>
              <span>Header/Footer</span>
            </button>
          </div>
          <div class="ribbon-group-label">Legal</div>
        </div>
        <!-- Tools group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-ocr" class="ribbon-btn ribbon-btn-lg" title="OCR â€” Recognize text in scanned pages" disabled>
              <span class="ribbon-icon" data-icon="file-scan" data-icon-size="20"></span>
              <span>OCR</span>
            </button>
          </div>
          <div class="ribbon-group-label">Tools</div>
        </div>
      </div>

      <!-- Ribbon: Annotate (hidden by default) -->
      <div class="ribbon-content" id="ribbon-annotate">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button class="ribbon-btn tool-btn" data-tool="select" title="Select (V)">
              <span class="ribbon-icon" data-icon="mouse-pointer"></span>
              <span>Select</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="text" title="Text (T)" disabled>
              <span class="ribbon-icon" data-icon="type"></span>
              <span>Text</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="highlight" title="Highlight" disabled>
              <span class="ribbon-icon" data-icon="highlighter"></span>
              <span>Highlight</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="underline" title="Underline" disabled>
              <span class="ribbon-icon" data-icon="underline"></span>
              <span>Underline</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="strikethrough" title="Strikethrough" disabled>
              <span class="ribbon-icon" data-icon="strikethrough"></span>
              <span>Strike</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="draw" title="Draw (D)" disabled>
              <span class="ribbon-icon" data-icon="pencil"></span>
              <span>Draw</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button class="ribbon-btn tool-btn" data-tool="shape" title="Shape" disabled>
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Shape</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="stamp" title="Stamp" disabled>
              <span class="ribbon-icon" data-icon="stamp"></span>
              <span>Stamp</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="cover" title="Visual Cover" disabled>
              <span class="ribbon-icon" data-icon="shield"></span>
              <span>Cover</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="redact" title="Redact" disabled>
              <span class="ribbon-icon" data-icon="shield-off"></span>
              <span>Redact</span>
            </button>
          </div>
          <div class="ribbon-group-label">Tools</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button class="ribbon-btn" disabled>
              <span class="ribbon-icon" data-icon="image"></span>
              <span>Image</span>
            </button>
            <button class="ribbon-btn sig-open-btn" title="Signature" disabled>
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="sticky-note" title="Sticky Note" disabled>
              <span class="ribbon-icon" data-icon="sticky-note"></span>
              <span>Note</span>
            </button>
            <button class="ribbon-btn" disabled>
              <span class="ribbon-icon" data-icon="droplet"></span>
              <span>Watermark</span>
            </button>
            <button id="btn-exhibit-stamp" class="ribbon-btn" title="Exhibit Stamp" disabled>
              <span class="ribbon-icon" data-icon="gavel"></span>
              <span>Exhibit</span>
            </button>
          </div>
          <div class="ribbon-group-label">Insert</div>
        </div>
      </div>

      <!-- Ribbon: Forms (hidden by default) -->
      <div class="ribbon-content" id="ribbon-forms">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-form-text" class="ribbon-btn" title="Add Text Field" disabled>
              <span class="ribbon-icon" data-icon="form-input"></span>
              <span>Text Field</span>
            </button>
            <button id="btn-form-checkbox" class="ribbon-btn" title="Add Checkbox" disabled>
              <span class="ribbon-icon" data-icon="check-circle"></span>
              <span>Checkbox</span>
            </button>
            <button id="btn-form-dropdown" class="ribbon-btn" title="Add Dropdown" disabled>
              <span class="ribbon-icon" data-icon="chevron-down"></span>
              <span>Dropdown</span>
            </button>
            <button id="btn-form-radio" class="ribbon-btn" title="Add Radio Button" disabled>
              <span class="ribbon-icon" data-icon="zap"></span>
              <span>Radio</span>
            </button>
            <button id="btn-form-signature" class="ribbon-btn" title="Add Signature Field" disabled>
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button id="btn-form-button" class="ribbon-btn" title="Add Push Button" disabled>
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Button</span>
            </button>
          </div>
          <div class="ribbon-group-label">Create Fields</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-form-import" class="ribbon-btn" title="Import Form Data" disabled>
              <span class="ribbon-icon" data-icon="upload"></span>
              <span>Import</span>
            </button>
            <button id="btn-form-export" class="ribbon-btn" title="Export Form Data" disabled>
              <span class="ribbon-icon" data-icon="save"></span>
              <span>Export</span>
            </button>
            <button id="btn-form-tab-order" class="ribbon-btn" title="Set Tab Order" disabled>
              <span class="ribbon-icon" data-icon="list-ordered"></span>
              <span>Tab Order</span>
            </button>
            <button id="btn-form-flatten" class="ribbon-btn" title="Flatten Form Fields" disabled>
              <span class="ribbon-icon" data-icon="layers"></span>
              <span>Flatten</span>
            </button>
          </div>
          <div class="ribbon-group-label">Form Data</div>
        </div>
      </div>

      <!-- Ribbon: Security (hidden by default) -->
      <div class="ribbon-content" id="ribbon-security">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-encrypt" class="ribbon-btn ribbon-btn-lg" title="Password Protect PDF" disabled>
              <span class="ribbon-icon" data-icon="key" data-icon-size="20"></span>
              <span>Encrypt</span>
            </button>
            <button id="btn-metadata" class="ribbon-btn ribbon-btn-lg" title="Edit/Remove Metadata" disabled>
              <span class="ribbon-icon" data-icon="file-lock" data-icon-size="20"></span>
              <span>Metadata</span>
            </button>
            <button id="btn-sanitize" class="ribbon-btn ribbon-btn-lg" title="Full Document Sanitization" disabled>
              <span class="ribbon-icon" data-icon="shield-check" data-icon-size="20"></span>
              <span>Sanitize</span>
            </button>
          </div>
          <div class="ribbon-group-label">Protect</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-redact-search" class="ribbon-btn ribbon-btn-lg" title="Search & Redact Sensitive Data" disabled>
              <span class="ribbon-icon" data-icon="scan" data-icon-size="20"></span>
              <span>Redact Search</span>
            </button>
          </div>
          <div class="ribbon-group-label">Redaction</div>
        </div>
      </div>

      <!-- Ribbon: Tools (hidden by default) -->
      <div class="ribbon-content" id="ribbon-tools">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-export-image" class="ribbon-btn ribbon-btn-lg" title="Export Pages to Images" disabled>
              <span class="ribbon-icon" data-icon="file-image" data-icon-size="20"></span>
              <span>Export Image</span>
            </button>
            <button id="btn-create-from-images" class="ribbon-btn ribbon-btn-lg" title="Create PDF from Images" disabled>
              <span class="ribbon-icon" data-icon="image" data-icon-size="20"></span>
              <span>Images â†’ PDF</span>
            </button>
            <button id="btn-optimize" class="ribbon-btn ribbon-btn-lg" title="Optimize/Compress PDF" disabled>
              <span class="ribbon-icon" data-icon="shrink" data-icon-size="20"></span>
              <span>Optimize</span>
            </button>
          </div>
          <div class="ribbon-group-label">Export</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-compare" class="ribbon-btn ribbon-btn-lg" title="Compare Two PDFs" disabled>
              <span class="ribbon-icon" data-icon="git-compare" data-icon-size="20"></span>
              <span>Compare</span>
            </button>
          </div>
          <div class="ribbon-group-label">Compare</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-comment-summary" class="ribbon-btn ribbon-btn-lg" title="Export Annotation Summary" disabled>
              <span class="ribbon-icon" data-icon="file-text" data-icon-size="20"></span>
              <span>Comments</span>
            </button>
            <button id="btn-flatten-annotations" class="ribbon-btn ribbon-btn-lg" title="Flatten Annotations into PDF" disabled>
              <span class="ribbon-icon" data-icon="layers" data-icon-size="20"></span>
              <span>Flatten</span>
            </button>
          </div>
          <div class="ribbon-group-label">Review</div>
        </div>
      </div>

    </div>

    <!-- â”€â”€ Main Content â”€â”€ -->
    <div id="main-container">

      <!-- Left Sidebar -->
      <aside id="sidebar">
        <div id="sidebar-tabs">
          <button class="sidebar-tab active" data-sidebar="pages" title="Pages">
            <span data-icon="layout-grid" data-icon-size="14"></span>
            <span class="sidebar-tab-label">Pages</span>
          </button>
          <button class="sidebar-tab" data-sidebar="bookmarks" title="Bookmarks">
            <span data-icon="bookmark" data-icon-size="14"></span>
            <span class="sidebar-tab-label">Bookmarks</span>
          </button>
          <button class="sidebar-tab" data-sidebar="notes" title="Notes">
            <span data-icon="message-square" data-icon-size="14"></span>
            <span class="sidebar-tab-label" style="position:relative;">Notes</span>
          </button>
          <button id="btn-toggle-sidebar" class="sidebar-collapse" title="Toggle Sidebar" data-icon="panel-left-close"></button>
        </div>
        <div class="sidebar-panel active" id="sidebar-pages">
          <div id="thumbnail-list"></div>
        </div>
        <div class="sidebar-panel" id="sidebar-bookmarks">
          <div class="sidebar-empty">
            <span data-icon="bookmark" data-icon-size="24"></span>
            <p>No bookmarks</p>
            <p class="sidebar-empty-hint">Bookmarks from the PDF outline will appear here.</p>
          </div>
        </div>
        <div class="sidebar-panel" id="sidebar-notes">
          <div class="sidebar-empty">
            <span data-icon="message-square" data-icon-size="24"></span>
            <p>No notes yet</p>
            <p class="sidebar-empty-hint">Add annotations to pages to see notes here.</p>
          </div>
        </div>
      </aside>

      <!-- Canvas Area -->
      <main id="canvas-area">
        <!-- Find Bar (Ctrl+F) -->
        <div id="find-bar" class="find-bar hidden">
          <span class="find-icon" data-icon="search" data-icon-size="14"></span>
          <input type="text" id="find-input" class="find-input" placeholder="Find in documentâ€¦" autocomplete="off" spellcheck="false">
          <span id="find-match-count" class="find-match-count"></span>
          <button id="find-prev" class="find-nav-btn" title="Previous (Shift+Enter)">
            <span data-icon="chevron-up" data-icon-size="14"></span>
          </button>
          <button id="find-next" class="find-nav-btn" title="Next (Enter)">
            <span data-icon="chevron-down" data-icon-size="14"></span>
          </button>
          <label class="find-case-toggle" title="Match Case">
            <input type="checkbox" id="find-case-sensitive">
            <span>Aa</span>
          </label>
          <button id="find-close" class="find-close-btn" title="Close (Esc)">
            <span data-icon="x" data-icon-size="14"></span>
          </button>
        </div>

        <div id="page-container">
          <canvas id="pdf-canvas"></canvas>
          <div id="text-layer"></div>
          <div id="fabric-canvas-wrapper">
            <canvas id="fabric-canvas"></canvas>
          </div>
          <!-- Visual Crop Overlay (inside page-container for positioning) -->
          <div id="crop-overlay" class="crop-overlay hidden">
            <div class="crop-shade crop-shade-top"></div>
            <div class="crop-shade crop-shade-bottom"></div>
            <div class="crop-shade crop-shade-left"></div>
            <div class="crop-shade crop-shade-right"></div>
            <div class="crop-selection">
              <div class="crop-handle" data-handle="nw"></div>
              <div class="crop-handle" data-handle="n"></div>
              <div class="crop-handle" data-handle="ne"></div>
              <div class="crop-handle" data-handle="e"></div>
              <div class="crop-handle" data-handle="se"></div>
              <div class="crop-handle" data-handle="s"></div>
              <div class="crop-handle" data-handle="sw"></div>
              <div class="crop-handle" data-handle="w"></div>
            </div>
          </div>
        </div>

        <!-- Floating Annotation Toolbar -->
        <div id="floating-toolbar" class="floating-toolbar hidden">
          <button class="float-btn active" data-tool="select" title="Select (V)">
            <span data-icon="mouse-pointer" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="hand" title="Hand Tool (H)">
            <span data-icon="hand" data-icon-size="16"></span>
          </button>
          <div class="float-sep"></div>
          <button class="float-btn" data-tool="text" title="Text (T)">
            <span data-icon="type" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="highlight" title="Highlight (L)">
            <span data-icon="highlighter" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="underline" title="Underline">
            <span data-icon="underline" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="strikethrough" title="Strikethrough">
            <span data-icon="strikethrough" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="draw" title="Draw (D)">
            <span data-icon="pencil" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="shape" title="Shape (R)">
            <span data-icon="square" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="cover" title="Visual Cover">
            <span data-icon="shield" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="redact" title="Redact">
            <span data-icon="shield-off" data-icon-size="16"></span>
          </button>
          <div class="float-sep"></div>
          <button class="float-btn" data-tool="stamp" title="Stamp">
            <span data-icon="stamp" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="image" title="Image">
            <span data-icon="image" data-icon-size="16"></span>
          </button>
          <button class="float-btn sig-open-btn" title="Signature">
            <span data-icon="pen-tool" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="sticky-note" title="Sticky Note">
            <span data-icon="sticky-note" data-icon-size="16"></span>
          </button>
        </div>
      </main>

      <!-- Properties Panel (right) -->
      <aside id="properties-panel" class="hidden">
        <div class="panel-header">
          <span class="panel-title">Properties</span>
          <button id="btn-close-panel" class="panel-close" title="Close Panel" data-icon="x" data-icon-size="14"></button>
        </div>
        <div class="panel-body">

          <!-- Tool Properties (dynamic â€” changes per active tool) -->
          <div class="panel-section" id="panel-tool-props">
            <div class="panel-section-title">Highlight Tool</div>
            <div class="prop-row">
              <span class="prop-label">Color</span>
              <div class="prop-color-row">
                <div class="color-swatch active" style="background:#fde047;" data-color="#fde047"></div>
                <div class="color-swatch" style="background:#86efac;" data-color="#86efac"></div>
                <div class="color-swatch" style="background:#93c5fd;" data-color="#93c5fd"></div>
                <div class="color-swatch" style="background:#fca5a5;" data-color="#fca5a5"></div>
                <div class="color-swatch" style="background:#c4b5fd;" data-color="#c4b5fd"></div>
                <div class="color-swatch" style="background:#fdba74;" data-color="#fdba74"></div>
              </div>
            </div>
            <div class="prop-row">
              <span class="prop-label">Opacity</span>
              <input type="range" class="prop-slider" id="prop-opacity" min="10" max="100" value="40">
              <span class="prop-slider-value" id="prop-opacity-value">40%</span>
            </div>
          </div>

          <!-- Document Info -->
          <div class="panel-section" id="panel-doc-info">
            <div class="panel-section-title">Document Info</div>
            <div class="prop-row">
              <span class="prop-label">Title</span>
              <input type="text" class="prop-input" id="prop-doc-title" placeholder="â€”">
            </div>
            <div class="prop-row">
              <span class="prop-label">Author</span>
              <input type="text" class="prop-input" id="prop-doc-author" placeholder="â€”">
            </div>
            <div class="prop-row">
              <span class="prop-label">Pages</span>
              <input type="text" class="prop-input prop-readonly" id="prop-doc-pages" value="â€”" readonly>
            </div>
            <div class="prop-row">
              <span class="prop-label">Size</span>
              <input type="text" class="prop-input prop-readonly" id="prop-doc-size" value="â€”" readonly>
            </div>
          </div>

          <!-- Page Settings -->
          <div class="panel-section" id="panel-page-settings">
            <div class="panel-section-title">Page Settings</div>
            <div class="prop-row">
              <span class="prop-label">Size</span>
              <select class="prop-select" id="prop-page-size">
                <option>Letter (8.5 x 11)</option>
                <option>A4 (210 x 297mm)</option>
                <option>Legal (8.5 x 14)</option>
              </select>
            </div>
            <div class="prop-row">
              <span class="prop-label">Orientation</span>
              <select class="prop-select" id="prop-page-orient">
                <option>Portrait</option>
                <option>Landscape</option>
              </select>
            </div>
          </div>

          <!-- Sticky Note Properties (hidden by default, shown when a note is selected) -->
          <div class="panel-section hidden" id="panel-note-props">
            <div class="panel-section-title">Note Text</div>
            <textarea id="prop-note-text" rows="4" placeholder="Type note textâ€¦"
              style="width:100%;resize:vertical;padding:8px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:13px;font-family:inherit;background:var(--mb-surface);color:var(--mb-text);"></textarea>
            <div class="prop-row" style="margin-top:8px;">
              <span class="prop-label">Color</span>
              <div class="prop-color-row" id="note-color-swatches">
                <div class="color-swatch active" style="background:#fff9c4;" data-note-color="yellow" title="Yellow"></div>
                <div class="color-swatch" style="background:#c8e6c9;" data-note-color="green" title="Green"></div>
                <div class="color-swatch" style="background:#bbdefb;" data-note-color="blue" title="Blue"></div>
                <div class="color-swatch" style="background:#f8bbd0;" data-note-color="pink" title="Pink"></div>
                <div class="color-swatch" style="background:#ffe0b2;" data-note-color="orange" title="Orange"></div>
              </div>
            </div>
          </div>

          <!-- Annotations on Current Page -->
          <div class="panel-section" id="panel-annotations">
            <div class="panel-section-title">Annotations on Page <span id="panel-anno-page">1</span></div>
            <div id="panel-anno-list" class="anno-list">
              <div class="sidebar-empty" style="padding:16px 8px;">
                <p>No annotations yet</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress bar (hidden by default, shown during OCR etc.) -->
        <div id="panel-progress" class="progress-section hidden">
          <div class="progress-label">
            <span id="progress-task">Processing</span>
            <span id="progress-detail"></span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width:0%;"></div>
          </div>
        </div>
      </aside>
    </div>

    <!-- â”€â”€ Page Navigation â”€â”€ -->
    <div id="page-nav">
      <button id="btn-first-page" class="page-nav-btn" title="First Page (Home)" disabled>
        <span data-icon="chevrons-left" data-icon-size="14"></span>
      </button>
      <button id="btn-prev-page" class="page-nav-btn" title="Previous Page (â†)" disabled>
        <span data-icon="chevron-left" data-icon-size="14"></span>
      </button>
      <input id="page-input" class="page-nav-input" type="number" min="1" value="1">
      <span class="page-nav-text">of <span id="total-pages">0</span></span>
      <button id="btn-next-page" class="page-nav-btn" title="Next Page (â†’)" disabled>
        <span data-icon="chevron-right" data-icon-size="14"></span>
      </button>
      <button id="btn-last-page" class="page-nav-btn" title="Last Page (End)" disabled>
        <span data-icon="chevrons-right" data-icon-size="14"></span>
      </button>
      <div class="page-nav-sep"></div>
      <span class="page-nav-label">Continuous scroll</span>
    </div>

    <!-- â”€â”€ Status Bar â”€â”€ -->
    <footer id="status-bar">
      <span id="statusbar-filename">No file loaded</span>
      <div class="status-sep"></div>
      <span id="status-pages-size"></span>
      <div class="status-sep"></div>
      <span id="status-badge-encrypted" class="status-badge encrypted hidden">
        <span data-icon="lock" data-icon-size="10"></span> Encrypted
      </span>
      <span id="status-badge-tagged" class="status-badge tagged hidden">Tagged</span>
      <div class="status-right">
        <span id="status-ocr" class="status-badge hidden" style="color:var(--mb-brand);font-size:11px;">OCR âœ“</span>
        <span id="status-bates" class="hidden">Bates: â€”</span>
        <div class="status-sep"></div>
        <div class="zoom-control">
          <button class="zoom-btn" id="status-zoom-out" title="Zoom Out">
            <span data-icon="minus" data-icon-size="12"></span>
          </button>
          <span class="zoom-val" id="status-zoom" title="Click to reset zoom">100%</span>
          <button class="zoom-btn" id="status-zoom-in" title="Zoom In">
            <span data-icon="plus" data-icon-size="12"></span>
          </button>
        </div>
      </div>
    </footer>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Toast Container â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="toast-container"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Loading Overlay â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Merge Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="merge-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Merge PDFs</h2>
        <button class="modal-close" data-close-modal="merge">&times;</button>
      </div>
      <div class="modal-body">
        <div id="merge-drop-zone" style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-md);padding:24px;text-align:center;margin-bottom:16px;cursor:pointer;">
          <p style="color:var(--mb-text-secondary);">Drop PDF files here or click to add</p>
          <input type="file" id="merge-file-input" accept=".pdf" multiple hidden>
        </div>
        <ul class="file-list" id="merge-file-list"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="merge">Cancel</button>
        <button class="btn-primary" id="btn-merge-execute" disabled>Merge Files</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Split Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="split-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Split PDF</h2>
        <button class="modal-close" data-close-modal="split">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:12px;color:var(--mb-text-secondary);font-size:13px;">
          Enter page ranges separated by commas. Example: 1-3, 5, 7-12
        </p>
        <input type="text" id="split-range-input"
          style="width:100%;padding:8px 12px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:14px;background:var(--mb-surface);color:var(--mb-text);"
          placeholder="e.g. 1-3, 5, 7-12">
        <div id="split-preview" style="margin-top:12px;font-size:13px;color:var(--mb-text-secondary);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="split">Cancel</button>
        <button class="btn-primary" id="btn-split-execute" disabled>Split</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Watermark Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="watermark-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Watermark</h2>
        <button class="modal-close" data-close-modal="watermark">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div>
            <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Text</label>
            <input type="text" id="watermark-text" value="CONFIDENTIAL"
              style="width:100%;padding:8px 12px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:14px;background:var(--mb-surface);color:var(--mb-text);"
              placeholder="Watermark text">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Font Size</label>
              <input type="number" id="watermark-size" value="60" min="10" max="200"
                style="width:100%;padding:8px 12px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:14px;background:var(--mb-surface);color:var(--mb-text);">
            </div>
            <div>
              <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Rotation (Â°)</label>
              <input type="number" id="watermark-rotation" value="-45" min="-180" max="180"
                style="width:100%;padding:8px 12px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:14px;background:var(--mb-surface);color:var(--mb-text);">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Opacity</label>
              <input type="range" id="watermark-opacity" min="0.05" max="0.5" step="0.05" value="0.15"
                style="width:100%;">
              <span id="watermark-opacity-value" style="font-size:12px;color:var(--mb-text-muted);">15%</span>
            </div>
            <div>
              <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Color</label>
              <input type="color" id="watermark-color" value="#888888"
                style="width:100%;height:36px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);background:var(--mb-surface);cursor:pointer;">
            </div>
          </div>
          <div>
            <label style="font-size:13px;color:var(--mb-text-secondary);display:block;margin-bottom:4px;">Apply to</label>
            <select id="watermark-pages"
              style="width:100%;padding:8px 12px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:14px;background:var(--mb-surface);color:var(--mb-text);">
              <option value="all">All Pages</option>
              <option value="current">Current Page Only</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="watermark">Cancel</button>
        <button class="btn-primary" id="btn-watermark-execute">Apply Watermark</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Bates Numbering Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="bates-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Bates Numbering</h2>
        <button class="modal-close" data-close-modal="bates">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="bates-label">Prefix</label>
              <input type="text" id="bates-prefix" value="" placeholder="e.g. DOC-"
                class="bates-field">
            </div>
            <div>
              <label class="bates-label">Suffix</label>
              <input type="text" id="bates-suffix" value="" placeholder="e.g. -R1"
                class="bates-field">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="bates-label">Start Number</label>
              <input type="number" id="bates-start" value="1" min="0"
                class="bates-field">
            </div>
            <div>
              <label class="bates-label">Zero Padding (digits)</label>
              <input type="number" id="bates-pad" value="6" min="1" max="12"
                class="bates-field">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="bates-label">Position</label>
              <select id="bates-position" class="bates-field">
                <option value="bottom-center">Bottom Center</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-right">Bottom Right</option>
                <option value="top-center">Top Center</option>
                <option value="top-left">Top Left</option>
                <option value="top-right">Top Right</option>
              </select>
            </div>
            <div>
              <label class="bates-label">Font Size</label>
              <input type="number" id="bates-font-size" value="10" min="6" max="36"
                class="bates-field">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="bates-label">Color</label>
              <input type="color" id="bates-color" value="#000000"
                style="width:100%;height:36px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);background:var(--mb-surface);cursor:pointer;">
            </div>
            <div>
              <label class="bates-label">Page Range</label>
              <select id="bates-page-range" class="bates-field">
                <option value="all">All Pages</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
          </div>
          <div id="bates-custom-range" class="hidden">
            <label class="bates-label">Pages (e.g. 1-5, 8, 10-12)</label>
            <input type="text" id="bates-range-input" placeholder="1-5, 8, 10-12"
              class="bates-field">
          </div>
          <div class="bates-preview-box">
            <span class="bates-label" style="margin-bottom:2px;">Preview</span>
            <span id="bates-preview" class="bates-preview-text">000001</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="bates">Cancel</button>
        <button class="btn-primary" id="btn-bates-execute">Apply Bates Numbers</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â• Headers & Footers Modal â•â•â•â•â•â•â• -->
  <div id="hf-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal-panel" style="max-width:580px">
      <div class="modal-header">
        <h3>Headers &amp; Footers</h3>
        <button class="modal-close" data-close-modal="hf">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px 24px">

        <!-- Token helper -->
        <div style="margin-bottom:16px">
          <label class="bates-label">Insert Token:</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{page}">Page #</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{pages}">Total Pages</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{date}">Date</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{filename}">Filename</button>
          </div>
        </div>

        <!-- Header row -->
        <div style="margin-bottom:12px">
          <label class="bates-label" style="font-weight:600">Header</label>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div>
              <label class="bates-label">Left</label>
              <input id="hf-top-left" class="bates-field hf-zone" placeholder="e.g. {filename}">
            </div>
            <div>
              <label class="bates-label">Center</label>
              <input id="hf-top-center" class="bates-field hf-zone" placeholder="e.g. Confidential">
            </div>
            <div>
              <label class="bates-label">Right</label>
              <input id="hf-top-right" class="bates-field hf-zone" placeholder="e.g. {date}">
            </div>
          </div>
        </div>

        <!-- Footer row -->
        <div style="margin-bottom:16px">
          <label class="bates-label" style="font-weight:600">Footer</label>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div>
              <label class="bates-label">Left</label>
              <input id="hf-bottom-left" class="bates-field hf-zone" placeholder="">
            </div>
            <div>
              <label class="bates-label">Center</label>
              <input id="hf-bottom-center" class="bates-field hf-zone" placeholder="e.g. Page {page} of {pages}">
            </div>
            <div>
              <label class="bates-label">Right</label>
              <input id="hf-bottom-right" class="bates-field hf-zone" placeholder="">
            </div>
          </div>
        </div>

        <!-- Options row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
          <div>
            <label class="bates-label">Font Size</label>
            <input id="hf-font-size" type="number" class="bates-field" value="10" min="6" max="36">
          </div>
          <div>
            <label class="bates-label">Color</label>
            <input id="hf-color" type="color" class="bates-field" value="#000000" style="height:38px;padding:4px">
          </div>
          <div>
            <label class="bates-label">Page Range</label>
            <select id="hf-page-range" class="bates-field">
              <option value="all">All Pages</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>

        <!-- Custom range (hidden by default) -->
        <div id="hf-custom-range" class="hidden" style="margin-bottom:16px">
          <label class="bates-label">Pages (e.g. 1-5, 8, 10-12)</label>
          <input id="hf-range-input" class="bates-field" placeholder="1-5, 8, 10-12">
        </div>

        <!-- Preview -->
        <div class="bates-preview-box">
          <span class="bates-label" style="margin-bottom:4px">Preview (page 1 of 10)</span>
          <div id="hf-preview" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;font-family:'Courier New',monospace;font-size:12px">
            <span id="hf-prev-tl" style="text-align:left;color:var(--mb-text-secondary)">â€”</span>
            <span id="hf-prev-tc" style="text-align:center;color:var(--mb-text-secondary)">â€”</span>
            <span id="hf-prev-tr" style="text-align:right;color:var(--mb-text-secondary)">â€”</span>
            <span id="hf-prev-bl" style="text-align:left;color:var(--mb-text-secondary)">â€”</span>
            <span id="hf-prev-bc" style="text-align:center;color:var(--mb-text-secondary)">â€”</span>
            <span id="hf-prev-br" style="text-align:right;color:var(--mb-text-secondary)">â€”</span>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="hf">Cancel</button>
        <button class="btn-primary" id="btn-hf-execute">Apply Headers &amp; Footers</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â• Crop Control Bar (visual crop overlay is in #page-container) â•â•â•â•â•â•â• -->
  <div id="crop-bar" class="crop-bar hidden">
    <span id="crop-bar-info" class="crop-bar-info">Drag handles to adjust crop</span>
    <div class="crop-bar-presets">
      <button class="btn-sm btn-secondary crop-preset" data-top="36" data-bottom="36" data-left="36" data-right="36">0.5"</button>
      <button class="btn-sm btn-secondary crop-preset" data-top="72" data-bottom="72" data-left="72" data-right="72">1"</button>
    </div>
    <select id="crop-scope" class="crop-bar-scope">
      <option value="current">Current Page</option>
      <option value="all">All Pages</option>
    </select>
    <button class="btn-primary btn-sm" id="btn-crop-execute">Apply Crop</button>
    <button class="btn-secondary btn-sm" id="btn-crop-cancel">Cancel</button>
  </div>
  <!-- Hidden inputs for crop values (used internally) -->
  <input type="hidden" id="crop-top" value="0">
  <input type="hidden" id="crop-bottom" value="0">
  <input type="hidden" id="crop-left" value="0">
  <input type="hidden" id="crop-right" value="0">
  <!-- Keep modal backdrop stub for close-modal handler compatibility -->
  <div id="crop-modal-backdrop" class="hidden"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Signature Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="signature-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal-panel" style="max-width:500px">
      <div class="modal-header">
        <h2>Signature</h2>
        <button class="modal-close" data-close-modal="signature">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px">
        <!-- Tabs -->
        <div style="display:flex;gap:0;border-bottom:1px solid var(--mb-border);margin-bottom:14px;">
          <button class="sig-tab active" data-sig-tab="draw"
            style="flex:1;padding:8px 0;border:none;background:none;font-size:13px;font-weight:600;cursor:pointer;color:var(--mb-text);border-bottom:2px solid transparent;"
          >Draw</button>
          <button class="sig-tab" data-sig-tab="type"
            style="flex:1;padding:8px 0;border:none;background:none;font-size:13px;font-weight:600;cursor:pointer;color:var(--mb-text-muted);border-bottom:2px solid transparent;"
          >Type</button>
          <button class="sig-tab" data-sig-tab="upload"
            style="flex:1;padding:8px 0;border:none;background:none;font-size:13px;font-weight:600;cursor:pointer;color:var(--mb-text-muted);border-bottom:2px solid transparent;"
          >Upload</button>
        </div>

        <!-- Draw Pane -->
        <div class="sig-pane" data-sig-pane="draw">
          <div style="border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);overflow:hidden;background:#fff;">
            <canvas id="sig-draw-canvas" width="420" height="160"></canvas>
          </div>
          <button id="sig-draw-clear" class="btn-secondary" style="margin-top:8px;font-size:12px;padding:4px 12px;">Clear</button>
        </div>

        <!-- Type Pane -->
        <div class="sig-pane hidden" data-sig-pane="type">
          <input type="text" id="sig-type-input" placeholder="Your name"
            style="width:100%;padding:10px 14px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:28px;font-family:'Dancing Script',cursive;background:var(--mb-surface);color:var(--mb-text);margin-bottom:10px;">
          <div>
            <label style="font-size:12px;color:var(--mb-text-secondary);margin-bottom:4px;display:block;">Font Style</label>
            <select id="sig-type-font"
              style="width:100%;padding:6px 10px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:13px;background:var(--mb-surface);color:var(--mb-text);">
              <option value="Dancing Script">Cursive (Dancing Script)</option>
              <option value="Caveat">Handwritten (Caveat)</option>
              <option value="Great Vibes">Elegant (Great Vibes)</option>
              <option value="Sacramento">Flowing (Sacramento)</option>
            </select>
          </div>
        </div>

        <!-- Upload Pane -->
        <div class="sig-pane hidden" data-sig-pane="upload">
          <div style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-sm);padding:24px;text-align:center;">
            <label for="sig-upload-input" style="cursor:pointer;color:var(--mb-accent);font-size:13px;font-weight:600;">
              Choose an image file
            </label>
            <input type="file" id="sig-upload-input" accept="image/png,image/jpeg,image/gif,image/webp" hidden>
            <p style="font-size:11px;color:var(--mb-text-muted);margin:6px 0 0;">PNG with transparent background recommended</p>
          </div>
          <img id="sig-upload-preview" class="hidden" style="max-width:100%;max-height:100px;margin-top:10px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);" alt="Preview">
        </div>

        <!-- Saved Signatures -->
        <div style="margin-top:16px;border-top:1px solid var(--mb-border);padding-top:12px;">
          <div style="font-size:12px;font-weight:600;color:var(--mb-text-secondary);margin-bottom:8px;">Saved Signatures</div>
          <div id="sig-saved-list" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="btn-sig-save">Save</button>
        <button class="btn-secondary" data-close-modal="signature">Cancel</button>
        <button class="btn-primary" id="btn-sig-insert">Insert</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for image insertion -->
  <input type="file" id="image-file-input" accept="image/png,image/jpeg,image/gif,image/webp" hidden>

  <!-- OCR Modal -->
  <div id="ocr-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:440px;">
      <div class="modal-header">
        <h2>OCR â€” Text Recognition</h2>
        <button class="modal-close" data-close-modal="ocr">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:16px;">
          Recognize text in scanned pages so you can search and select text. Uses Tesseract.js (runs locally in your browser).
        </p>

        <!-- Page selection -->
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;font-weight:600;display:block;margin-bottom:8px;">Pages to OCR</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="radio" name="ocr-scope" value="current" checked> Current page
            </label>
            <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="radio" name="ocr-scope" value="all"> All pages
            </label>
            <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="radio" name="ocr-scope" value="range"> Page range
              <input type="text" id="ocr-range-input" placeholder="e.g. 1-5, 8"
                style="width:120px;padding:4px 8px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:12px;background:var(--mb-surface-alt);color:var(--mb-text);">
            </label>
          </div>
        </div>

        <!-- Progress area (hidden until running) -->
        <div id="ocr-progress-area" class="hidden" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
            <span id="ocr-progress-label">Startingâ€¦</span>
            <span id="ocr-progress-pct">0%</span>
          </div>
          <div style="height:6px;background:var(--mb-surface-alt);border-radius:3px;overflow:hidden;">
            <div id="ocr-progress-bar" style="height:100%;width:0%;background:var(--mb-brand);border-radius:3px;transition:width 200ms;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="ocr">Cancel</button>
        <button class="btn-primary" id="btn-ocr-run">Run OCR</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Encrypt Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="encrypt-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:460px;">
      <div class="modal-header">
        <h2>Password Protect PDF</h2>
        <button class="modal-close" data-close-modal="encrypt">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div>
            <label class="bates-label">User Password (to open)</label>
            <input type="password" id="encrypt-user-pw" class="bates-field" placeholder="Leave blank for no open password">
          </div>
          <div>
            <label class="bates-label">Owner Password (to edit)</label>
            <input type="password" id="encrypt-owner-pw" class="bates-field" placeholder="Required">
          </div>
          <div>
            <label class="bates-label">Permissions</label>
            <div style="display:flex;flex-direction:column;gap:6px;font-size:13px;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="perm-print" checked> Allow Printing
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="perm-copy" checked> Allow Copying
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="perm-modify" checked> Allow Modifying
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="perm-annotate" checked> Allow Annotating
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="perm-fill-forms"> Allow Form Filling Only
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="encrypt">Cancel</button>
        <button class="btn-primary" id="btn-encrypt-execute">Encrypt PDF</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Metadata Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="metadata-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h2>Document Metadata</h2>
        <button class="modal-close" data-close-modal="metadata">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div>
            <label class="bates-label">Title</label>
            <input type="text" id="meta-title" class="bates-field" placeholder="Document title">
          </div>
          <div>
            <label class="bates-label">Author</label>
            <input type="text" id="meta-author" class="bates-field" placeholder="Author name">
          </div>
          <div>
            <label class="bates-label">Subject</label>
            <input type="text" id="meta-subject" class="bates-field" placeholder="Document subject">
          </div>
          <div>
            <label class="bates-label">Keywords</label>
            <input type="text" id="meta-keywords" class="bates-field" placeholder="keyword1, keyword2">
          </div>
          <div>
            <label class="bates-label">Creator</label>
            <input type="text" id="meta-creator" class="bates-field" readonly>
          </div>
          <div>
            <label class="bates-label">Producer</label>
            <input type="text" id="meta-producer" class="bates-field" readonly>
          </div>
          <div>
            <label class="bates-label">Creation Date</label>
            <input type="text" id="meta-creation-date" class="bates-field" readonly>
          </div>
          <div>
            <label class="bates-label">Modification Date</label>
            <input type="text" id="meta-mod-date" class="bates-field" readonly>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="btn-meta-remove" style="color:var(--mb-danger);">Remove All Metadata</button>
        <button class="btn-secondary" data-close-modal="metadata">Cancel</button>
        <button class="btn-primary" id="btn-meta-save">Save Metadata</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Redaction Search Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="redact-search-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:520px;">
      <div class="modal-header">
        <h2>Search &amp; Redact</h2>
        <button class="modal-close" data-close-modal="redact-search">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:16px;">
          Auto-detect and redact sensitive data. Select patterns to search for:
        </p>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="ssn"> Social Security Numbers (XXX-XX-XXXX)
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="creditCard"> Credit Card Numbers
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="email"> Email Addresses
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="phone"> Phone Numbers
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="date"> Dates
          </label>
          <label style="font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" class="redact-pattern-cb" value="custom"> Custom Pattern
          </label>
        </div>
        <div id="redact-custom-row" class="hidden" style="margin-bottom:16px;">
          <label class="bates-label">Custom Regex or Text</label>
          <input type="text" id="redact-custom-input" class="bates-field" placeholder="e.g. ACME Corp or \\d{3}-\\d{4}">
        </div>
        <div id="redact-results" class="hidden" style="border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);max-height:200px;overflow-y:auto;padding:8px;">
          <div id="redact-results-list" style="font-size:13px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="redact-search">Cancel</button>
        <button class="btn-primary" id="btn-redact-search-execute">Search</button>
        <button class="btn-primary hidden" id="btn-redact-apply">Apply Redactions</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Export to Image Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="export-image-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h2>Export Pages to Image</h2>
        <button class="modal-close" data-close-modal="export-image">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div>
            <label class="bates-label">Pages</label>
            <select id="export-img-scope" class="bates-field">
              <option value="current">Current Page</option>
              <option value="all">All Pages</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div id="export-img-range-row" class="hidden">
            <label class="bates-label">Page Range (e.g. 1-5, 8)</label>
            <input type="text" id="export-img-range" class="bates-field" placeholder="1-5, 8, 10-12">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="bates-label">Format</label>
              <select id="export-img-format" class="bates-field">
                <option value="png">PNG</option>
                <option value="jpg">JPEG</option>
              </select>
            </div>
            <div>
              <label class="bates-label">DPI</label>
              <select id="export-img-dpi" class="bates-field">
                <option value="72">72 (Screen)</option>
                <option value="150" selected>150 (Standard)</option>
                <option value="300">300 (Print)</option>
                <option value="600">600 (High Quality)</option>
              </select>
            </div>
          </div>
          <div id="export-img-quality-row">
            <label class="bates-label">JPEG Quality</label>
            <input type="range" id="export-img-quality" min="50" max="100" value="92" style="width:100%;">
            <span id="export-img-quality-val" style="font-size:12px;color:var(--mb-text-muted);">92%</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="export-image">Cancel</button>
        <button class="btn-primary" id="btn-export-image-execute">Export</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Create PDF from Images Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="create-from-images-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <h2>Create PDF from Images</h2>
        <button class="modal-close" data-close-modal="create-from-images">&times;</button>
      </div>
      <div class="modal-body">
        <div id="images-drop-zone" style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-md);padding:24px;text-align:center;margin-bottom:16px;cursor:pointer;">
          <p style="color:var(--mb-text-secondary);">Drop image files here or click to add</p>
          <p style="font-size:11px;color:var(--mb-text-muted);">PNG, JPEG, GIF, WebP</p>
          <input type="file" id="images-file-input" accept="image/*" multiple hidden>
        </div>
        <ul class="file-list" id="images-file-list"></ul>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
          <div>
            <label class="bates-label">Page Size</label>
            <select id="images-page-size" class="bates-field">
              <option value="fit">Fit to Image</option>
              <option value="letter">Letter (8.5 x 11)</option>
              <option value="a4">A4</option>
              <option value="legal">Legal</option>
            </select>
          </div>
          <div>
            <label class="bates-label">Margin (pt)</label>
            <input type="number" id="images-margin" class="bates-field" value="0" min="0" max="144">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="create-from-images">Cancel</button>
        <button class="btn-primary" id="btn-create-from-images-execute" disabled>Create PDF</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Optimize PDF Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="optimize-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h2>Optimize PDF</h2>
        <button class="modal-close" data-close-modal="optimize">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:16px;">
          Reduce file size by re-rendering pages as compressed images. Text will be rasterized (lossy).
        </p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label class="bates-label">DPI</label>
            <select id="optimize-dpi" class="bates-field">
              <option value="72">72 (Smallest)</option>
              <option value="150" selected>150 (Balanced)</option>
              <option value="300">300 (Quality)</option>
            </select>
          </div>
          <div>
            <label class="bates-label">JPEG Quality</label>
            <input type="range" id="optimize-quality" min="30" max="95" value="75" style="width:100%;">
            <span id="optimize-quality-val" style="font-size:12px;color:var(--mb-text-muted);">75%</span>
          </div>
        </div>
        <div id="optimize-result" class="hidden" style="margin-top:16px;padding:12px;background:var(--mb-surface-sunken);border-radius:var(--mb-radius-sm);font-size:13px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="optimize">Cancel</button>
        <button class="btn-primary" id="btn-optimize-execute">Optimize</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Document Compare Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="compare-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal-panel" style="max-width:90vw;width:900px;">
      <div class="modal-header">
        <h2>Compare Documents</h2>
        <button class="modal-close" data-close-modal="compare">&times;</button>
      </div>
      <div class="modal-body" style="padding:16px 20px;">
        <!-- File selection (shown first) -->
        <div id="compare-setup">
          <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:16px;">
            Compare the current document with another PDF to see differences.
          </p>
          <div style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-md);padding:24px;text-align:center;cursor:pointer;" id="compare-drop-zone">
            <p style="color:var(--mb-text-secondary);">Drop the second PDF here or click to select</p>
            <input type="file" id="compare-file-input" accept=".pdf" hidden>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <div>
              <label class="bates-label">Comparison DPI</label>
              <select id="compare-dpi" class="bates-field">
                <option value="72">72 (Fast)</option>
                <option value="96" selected>96 (Default)</option>
                <option value="150">150 (Detailed)</option>
              </select>
            </div>
            <div>
              <label class="bates-label">Sensitivity</label>
              <select id="compare-threshold" class="bates-field">
                <option value="15">High (15)</option>
                <option value="30" selected>Normal (30)</option>
                <option value="50">Low (50)</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Results (shown after comparison) -->
        <div id="compare-results" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div id="compare-summary" style="font-size:13px;color:var(--mb-text-secondary);"></div>
            <div style="display:flex;gap:6px;">
              <select id="compare-view-mode" class="bates-field" style="width:auto;">
                <option value="side-by-side">Side by Side</option>
                <option value="overlay">Overlay</option>
                <option value="diff-only">Diff Only</option>
              </select>
              <button class="btn-secondary btn-sm" id="btn-compare-prev" disabled>&larr; Prev</button>
              <span id="compare-page-info" style="font-size:13px;padding:4px 8px;">Page 1</span>
              <button class="btn-secondary btn-sm" id="btn-compare-next" disabled>Next &rarr;</button>
            </div>
          </div>
          <div id="compare-view" style="min-height:300px;border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);padding:8px;background:var(--mb-surface-sunken);"></div>
          <pre id="compare-report" class="hidden" style="margin-top:12px;font-size:12px;max-height:200px;overflow:auto;padding:12px;background:var(--mb-surface-sunken);border-radius:var(--mb-radius-sm);"></pre>
        </div>
        <!-- Progress -->
        <div id="compare-progress" class="hidden" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
            <span id="compare-progress-label">Comparingâ€¦</span>
            <span id="compare-progress-pct">0%</span>
          </div>
          <div style="height:6px;background:var(--mb-surface-alt);border-radius:3px;overflow:hidden;">
            <div id="compare-progress-bar" style="height:100%;width:0%;background:var(--mb-brand);border-radius:3px;transition:width 200ms;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="btn-compare-report" class="hidden">View Report</button>
        <button class="btn-secondary" data-close-modal="compare">Close</button>
        <button class="btn-primary" id="btn-compare-execute" disabled>Compare</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Comment Summary Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="comment-summary-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h2>Annotation Summary</h2>
        <button class="modal-close" data-close-modal="comment-summary">&times;</button>
      </div>
      <div class="modal-body">
        <div id="comment-summary-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">
          <div style="background:var(--mb-surface-sunken);padding:12px;border-radius:var(--mb-radius-sm);text-align:center;">
            <div id="comment-stat-total" style="font-size:24px;font-weight:700;color:var(--mb-brand);">0</div>
            <div style="font-size:11px;color:var(--mb-text-muted);">Total Annotations</div>
          </div>
          <div style="background:var(--mb-surface-sunken);padding:12px;border-radius:var(--mb-radius-sm);text-align:center;">
            <div id="comment-stat-pages" style="font-size:24px;font-weight:700;color:var(--mb-brand);">0</div>
            <div style="font-size:11px;color:var(--mb-text-muted);">Pages With Annotations</div>
          </div>
          <div style="background:var(--mb-surface-sunken);padding:12px;border-radius:var(--mb-radius-sm);text-align:center;">
            <div id="comment-stat-types" style="font-size:24px;font-weight:700;color:var(--mb-brand);">0</div>
            <div style="font-size:11px;color:var(--mb-text-muted);">Annotation Types</div>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <label class="bates-label">Export Format</label>
          <select id="comment-export-format" class="bates-field" style="width:auto;">
            <option value="text">Plain Text</option>
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
        <pre id="comment-summary-preview" style="max-height:250px;overflow:auto;padding:12px;background:var(--mb-surface-sunken);border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);font-size:12px;white-space:pre-wrap;"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="btn-flatten-anno-exec" style="color:var(--mb-danger);">Flatten All</button>
        <button class="btn-secondary" data-close-modal="comment-summary">Close</button>
        <button class="btn-primary" id="btn-comment-download">Download</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Form Data Import/Export Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="form-data-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h2 id="form-data-modal-title">Form Data</h2>
        <button class="modal-close" data-close-modal="form-data">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Import pane -->
        <div id="form-import-pane" class="hidden">
          <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:12px;">
            Import form data from a JSON, XFDF, or CSV file.
          </p>
          <div style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-md);padding:24px;text-align:center;cursor:pointer;" id="form-import-drop-zone">
            <p style="color:var(--mb-text-secondary);">Drop file here or click to select</p>
            <p style="font-size:11px;color:var(--mb-text-muted);">JSON, XFDF, or CSV</p>
            <input type="file" id="form-import-file-input" accept=".json,.xfdf,.csv" hidden>
          </div>
          <div id="form-import-preview" class="hidden" style="margin-top:12px;padding:12px;background:var(--mb-surface-sunken);border-radius:var(--mb-radius-sm);font-size:12px;max-height:150px;overflow:auto;"></div>
        </div>
        <!-- Export pane -->
        <div id="form-export-pane" class="hidden">
          <p style="font-size:13px;color:var(--mb-text-secondary);margin-bottom:12px;">
            Export current form data to a file.
          </p>
          <label class="bates-label">Format</label>
          <select id="form-export-format" class="bates-field">
            <option value="json">JSON</option>
            <option value="xfdf">XFDF (Adobe Compatible)</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="form-data">Cancel</button>
        <button class="btn-primary" id="btn-form-data-execute">Execute</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Exhibit Stamp Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="exhibit-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h2>Exhibit Stamp</h2>
        <button class="modal-close" data-close-modal="exhibit">&times;</button>
      </div>
      <div class="modal-body">
        <label class="bates-label">Numbering Format</label>
        <select id="exhibit-format" class="bates-field">
          <option value="letter">A, B, C...</option>
          <option value="number">1, 2, 3...</option>
          <option value="roman-upper">I, II, III...</option>
          <option value="roman-lower">i, ii, iii...</option>
        </select>
        <label class="bates-label" style="margin-top:12px;">Prefix (optional)</label>
        <input type="text" id="exhibit-prefix" class="bates-field" placeholder="e.g. Plaintiff's ">
        <label style="display:flex;align-items:center;gap:8px;margin-top:12px;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exhibit-include-date" checked>
          Include date on stamp
        </label>
        <div style="margin-top:16px;padding:16px;background:var(--mb-surface-secondary);border-radius:var(--mb-radius-md);text-align:center;">
          <p style="margin:0 0 4px;font-size:11px;color:var(--mb-text-muted);">Preview</p>
          <div id="exhibit-preview" style="font-weight:bold;color:#1565c0;font-size:18px;">EXHIBIT A</div>
        </div>
        <p style="margin-top:12px;font-size:12px;color:var(--mb-text-muted);">
          Click anywhere on the page to place the exhibit stamp. Numbers auto-increment.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="exhibit">Cancel</button>
        <button class="btn-primary" id="btn-exhibit-execute">Place Stamp</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Sanitize Document Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="sanitize-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:440px;">
      <div class="modal-header">
        <h2>Sanitize Document</h2>
        <button class="modal-close" data-close-modal="sanitize">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 12px;font-size:13px;color:var(--mb-text-secondary);">
          Remove all hidden data before filing or sharing. This will strip:
        </p>
        <div style="padding:12px;background:var(--mb-surface-secondary);border-radius:var(--mb-radius-md);">
          <ul style="margin:0 0 0 20px;font-size:13px;color:var(--mb-text);line-height:1.8;">
            <li>Document title, author, subject, keywords</li>
            <li>Creator and producer software tags</li>
            <li>Creation and modification dates</li>
            <li>Revision history and XMP metadata</li>
          </ul>
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin-top:16px;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="sanitize-confirm">
          I understand this cannot be undone
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="sanitize">Cancel</button>
        <button class="btn-primary" id="btn-sanitize-execute" disabled>Sanitize Document</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Page Labels Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-labels-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h2>Page Labels</h2>
        <button class="modal-close" data-close-modal="page-labels">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 12px;font-size:13px;color:var(--mb-text-secondary);">
          Define custom numbering for different document sections (e.g. roman numerals for front matter).
        </p>
        <div id="page-labels-list" style="display:flex;flex-direction:column;gap:8px;max-height:250px;overflow-y:auto;">
          <!-- Rows added dynamically -->
        </div>
        <button id="btn-add-label-range" class="btn-secondary" style="margin-top:12px;width:100%;font-size:13px;">+ Add Range</button>
        <div style="margin-top:12px;padding:12px;background:var(--mb-surface-secondary);border-radius:var(--mb-radius-md);max-height:120px;overflow-y:auto;">
          <p style="margin:0 0 4px;font-size:11px;color:var(--mb-text-muted);">Preview</p>
          <div id="page-labels-preview" style="font-size:12px;color:var(--mb-text);display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="page-labels">Cancel</button>
        <button class="btn-primary" id="btn-page-labels-apply">Apply Labels</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Replace Pages Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="replace-pages-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <h2>Replace Pages</h2>
        <button class="modal-close" data-close-modal="replace-pages">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 12px;font-size:13px;color:var(--mb-text-secondary);">
          Replace pages in the current document with pages from another PDF.
        </p>
        <div id="replace-source-drop" style="border:2px dashed var(--mb-border);border-radius:var(--mb-radius-md);padding:24px;text-align:center;cursor:pointer;">
          <p style="color:var(--mb-text-secondary);margin:0;">Click to choose source PDF</p>
          <p style="font-size:11px;color:var(--mb-text-muted);margin:4px 0 0;">or drag and drop</p>
          <input type="file" id="replace-file-input" accept=".pdf" hidden>
        </div>
        <div id="replace-mapping" class="hidden" style="margin-top:16px;">
          <p style="font-size:13px;color:var(--mb-text-secondary);margin:0 0 8px;">
            Source: <strong id="replace-source-name"></strong> (<span id="replace-source-pages"></span> pages)
          </p>
          <div style="border:1px solid var(--mb-border);border-radius:var(--mb-radius-sm);overflow:auto;max-height:250px;">
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
              <thead style="background:var(--mb-surface-secondary);position:sticky;top:0;">
                <tr>
                  <th style="padding:8px;text-align:left;border-bottom:1px solid var(--mb-border);">Current Page</th>
                  <th style="padding:8px;text-align:left;border-bottom:1px solid var(--mb-border);">Replace With</th>
                </tr>
              </thead>
              <tbody id="replace-mappings-list"></tbody>
            </table>
          </div>
          <label style="display:flex;align-items:center;gap:8px;margin-top:12px;font-size:12px;color:var(--mb-text-muted);cursor:pointer;">
            <input type="checkbox" id="replace-confirm">
            I understand replaced pages cannot be recovered
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="replace-pages">Cancel</button>
        <button class="btn-primary" id="btn-replace-execute" disabled>Replace Pages</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for creating PDF from images -->
  <input type="file" id="create-images-file-input" accept="image/*" multiple hidden>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Service Worker Registration â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• App Entry Point (ES Module) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script type="module" src="js/app.js"></script>

</body>
</html>
