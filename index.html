<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mudbrick â€” Free PDF Editor</title>
  <meta name="description" content="Free, open-source PDF editor. No subscription. No dark patterns. Runs entirely in your browser.">

  <!-- Styles -->
  <link rel="stylesheet" href="styles/variables.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/components.css">

  <!-- CDN: Google Fonts for signature cursive styles (lazy-loaded) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Dancing+Script&family=Great+Vibes&family=Sacramento&display=swap" rel="stylesheet">

  <!-- CDN: pdf-lib (UMD, sets window.PDFLib) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- CDN: Fabric.js 5.3 (IIFE, sets window.fabric) -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <meta name="theme-color" content="#c0392b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="application-name" content="Mudbrick">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>">

  <!-- Favicon (brick emoji) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>">
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Welcome Screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="welcome-screen">
    <div class="welcome-content">
      <h1>ðŸ§± Mudbrick</h1>
      <p class="tagline">Free PDF editor. No subscription. No dark patterns.</p>

      <div class="welcome-privacy">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Your files never leave your device
      </div>

      <div id="drop-zone">
        <div class="drop-icon" data-icon="file" data-icon-size="48"></div>
        <div class="drop-text">Drop a PDF or image here</div>
        <div class="drop-or">or</div>
        <button class="btn-primary" id="open-file-btn">Open File</button>
        <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.bmp,.tiff" hidden aria-label="File Input">
      </div>

      <div class="welcome-features">
        <span>View &amp; Navigate</span>
        <span>Annotate &amp; Draw</span>
        <span>Merge &amp; Split</span>
        <span>Fill Forms</span>
        <span>Visual Cover</span>
        <span>Watermark</span>
        <span>100% Client-Side</span>
      </div>

      <!-- Recent Files -->
      <div id="recent-files" class="recent-files hidden">
        <div class="recent-files-header">
          <span data-icon="clock" data-icon-size="14"></span>
          <span>Recent Files</span>
          <button id="btn-clear-recent" class="recent-clear-btn" title="Clear recent files" aria-label="Clear recent files">&times;</button>
        </div>
        <ul id="recent-files-list" class="recent-files-list"></ul>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• App Shell â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app" class="hidden">

    <!-- â”€â”€ Title Bar â”€â”€ -->
    <div id="titlebar" role="banner">
      <div class="brand">
        <div class="brand-icon">M</div>
        <span class="brand-name">Mudbrick</span>
      </div>
      <div class="menu-items">
        <button class="menu-item">File</button>
        <button class="menu-item">Edit</button>
        <button class="menu-item">View</button>
        <button class="menu-item">Insert</button>
        <button class="menu-item">Tools</button>
        <button class="menu-item">Help</button>
      </div>
      <span id="status-filename" class="title-filename">No file loaded</span>
      <div class="titlebar-right">
        <button id="btn-dark-mode" class="titlebar-btn" title="Toggle Dark Mode" aria-label="Toggle dark mode" data-icon="moon"></button>
      </div>
    </div>

    <!-- â”€â”€ Ribbon Tab Strip â”€â”€ -->
    <div id="ribbon-tabs" role="tablist" aria-label="Tool tabs">
      <button class="ribbon-tab active" data-ribbon="home">Home</button>
      <button class="ribbon-tab" data-ribbon="edit">Edit</button>
      <button class="ribbon-tab" data-ribbon="annotate">Annotate</button>
      <button class="ribbon-tab" data-ribbon="forms">Forms</button>
      <button class="ribbon-tab" data-ribbon="security">Security</button>
      <button class="ribbon-tab" data-ribbon="tools">Tools</button>
    </div>

    <!-- â”€â”€ Ribbon Panel (contextual toolbar) â”€â”€ -->
    <div id="ribbon-panel" role="toolbar" aria-label="Active tool options">

      <!-- Ribbon: Home (default) -->
      <div class="ribbon-content active" id="ribbon-home">
        <!-- File group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-open" class="ribbon-btn ribbon-btn-lg" title="Open PDF (Ctrl+O)" aria-label="Open PDF">
              <span class="ribbon-icon" data-icon="folder-open" data-icon-size="20"></span>
              <span>Open</span>
            </button>
            <button id="btn-export" class="ribbon-btn ribbon-btn-lg" title="Export (Ctrl+S)" disabled aria-label="Export">
              <span class="ribbon-icon" data-icon="save" data-icon-size="20"></span>
              <span>Export</span>
            </button>
          </div>
          <div class="ribbon-group-label">File</div>
        </div>

        <!-- Undo/Redo group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-undo" class="ribbon-btn" title="Undo (Ctrl+Z)" aria-label="Undo" disabled>
              <span class="ribbon-icon" data-icon="undo"></span>
              <span>Undo</span>
            </button>
            <button id="btn-redo" class="ribbon-btn" title="Redo (Ctrl+Y)" aria-label="Redo" disabled>
              <span class="ribbon-icon" data-icon="redo"></span>
              <span>Redo</span>
            </button>
          </div>
          <div class="ribbon-group-label">History</div>
        </div>

        <!-- Organize group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-merge" class="ribbon-btn ribbon-btn-lg" title="Merge PDFs" disabled aria-label="Merge PDFs">
              <span class="ribbon-icon" data-icon="link" data-icon-size="20"></span>
              <span>Merge</span>
            </button>
            <button id="btn-split" class="ribbon-btn ribbon-btn-lg" title="Split PDF" disabled aria-label="Split PDF">
              <span class="ribbon-icon" data-icon="scissors" data-icon-size="20"></span>
              <span>Split</span>
            </button>
          </div>
          <div class="ribbon-group-label">Organize</div>
        </div>

        <!-- Annotate Quick group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-text" class="ribbon-btn tool-btn" data-tool="text" title="Text (T)" disabled aria-label="Text">
              <span class="ribbon-icon" data-icon="type"></span>
              <span>Text</span>
            </button>
            <button id="btn-highlight" class="ribbon-btn tool-btn" data-tool="highlight" title="Highlight" disabled aria-label="Highlight">
              <span class="ribbon-icon" data-icon="highlighter"></span>
              <span>Highlight</span>
            </button>
            <button id="btn-underline" class="ribbon-btn tool-btn" data-tool="underline" title="Underline" disabled aria-label="Underline">
              <span class="ribbon-icon" data-icon="underline"></span>
              <span>Underline</span>
            </button>
            <button id="btn-strikethrough" class="ribbon-btn tool-btn" data-tool="strikethrough" title="Strikethrough" disabled aria-label="Strikethrough">
              <span class="ribbon-icon" data-icon="strikethrough"></span>
              <span>Strike</span>
            </button>
            <button id="btn-draw" class="ribbon-btn tool-btn" data-tool="draw" title="Draw (D)" disabled aria-label="Draw">
              <span class="ribbon-icon" data-icon="pencil"></span>
              <span>Draw</span>
            </button>
            <button id="btn-stamp" class="ribbon-btn tool-btn" data-tool="stamp" title="Stamp" disabled aria-label="Stamp">
              <span class="ribbon-icon" data-icon="stamp"></span>
              <span>Stamp</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button id="btn-shape" class="ribbon-btn tool-btn" data-tool="shape" title="Shape" disabled aria-label="Shape">
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Shape</span>
            </button>
            <button id="btn-cover" class="ribbon-btn tool-btn" data-tool="cover" title="Visual Cover" disabled aria-label="Visual Cover">
              <span class="ribbon-icon" data-icon="shield"></span>
              <span>Cover</span>
            </button>
            <button id="btn-redact" class="ribbon-btn tool-btn" data-tool="redact" title="Redact" disabled aria-label="Redact">
              <span class="ribbon-icon" data-icon="shield-off"></span>
              <span>Redact</span>
            </button>
            <button id="btn-insert-image" class="ribbon-btn" title="Insert Image" disabled aria-label="Insert Image">
              <span class="ribbon-icon" data-icon="image"></span>
              <span>Image</span>
            </button>
            <button id="btn-signature" class="ribbon-btn" title="Signature" disabled aria-label="Signature">
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button id="btn-sticky-note" class="ribbon-btn tool-btn" data-tool="sticky-note" title="Sticky Note" disabled aria-label="Sticky Note">
              <span class="ribbon-icon" data-icon="sticky-note"></span>
              <span>Note</span>
            </button>
            <button id="btn-watermark" class="ribbon-btn" title="Watermark" disabled aria-label="Watermark">
              <span class="ribbon-icon" data-icon="droplet"></span>
              <span>Watermark</span>
            </button>
          </div>
          <div class="ribbon-group-label">Annotate</div>
        </div>

        <!-- View group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-select" class="ribbon-btn tool-btn active" data-tool="select" title="Select (V)" aria-label="Select">
              <span class="ribbon-icon" data-icon="mouse-pointer"></span>
              <span>Select</span>
            </button>
            <button id="btn-hand" class="ribbon-btn tool-btn" data-tool="hand" title="Hand (H)" aria-label="Hand">
              <span class="ribbon-icon" data-icon="hand"></span>
              <span>Hand</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button id="btn-zoom-out" class="ribbon-btn" title="Zoom Out (-)" aria-label="Zoom Out">
              <span class="ribbon-icon" data-icon="minus"></span>
            </button>
            <button id="btn-zoom-level" class="ribbon-btn" title="Click to reset" aria-label="Reset Zoom">100%</button>
            <button id="btn-zoom-in" class="ribbon-btn" title="Zoom In (+)" aria-label="Zoom In">
              <span class="ribbon-icon" data-icon="plus"></span>
            </button>
            <button id="btn-fit-width" class="ribbon-btn" title="Fit Width" aria-label="Fit Width">
              <span class="ribbon-icon" data-icon="columns"></span>
            </button>
            <button id="btn-fit-page" class="ribbon-btn" title="Fit Page" aria-label="Fit Page">
              <span class="ribbon-icon" data-icon="maximize"></span>
            </button>
          </div>
          <div class="ribbon-group-label">View</div>
        </div>
      </div>

      <!-- Ribbon: Edit (hidden by default) -->
      <div class="ribbon-content" id="ribbon-edit">
        <!-- Page group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-insert-blank" class="ribbon-btn ribbon-btn-lg" title="Insert Blank Page" disabled aria-label="Insert Blank Page">
              <span class="ribbon-icon" data-icon="file-plus" data-icon-size="20"></span>
              <span>Insert Page</span>
            </button>
            <button id="btn-replace-pages" class="ribbon-btn ribbon-btn-lg" title="Replace Pages" disabled aria-label="Replace Pages">
              <span class="ribbon-icon" data-icon="replace" data-icon-size="20"></span>
              <span>Replace</span>
            </button>
            <button id="btn-crop-page" class="ribbon-btn ribbon-btn-lg" title="Crop Page" disabled aria-label="Crop Page">
              <span class="ribbon-icon" data-icon="crop" data-icon-size="20"></span>
              <span>Crop</span>
            </button>
            <button id="btn-page-labels" class="ribbon-btn ribbon-btn-lg" title="Page Labels" disabled aria-label="Page Labels">
              <span class="ribbon-icon" data-icon="tag" data-icon-size="20"></span>
              <span>Labels</span>
            </button>
          </div>
          <div class="ribbon-group-label">Page</div>
        </div>
        <!-- Content group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-edit-text" class="ribbon-btn" title="Edit existing text on this page" disabled aria-label="Edit existing text on this page">
              <span class="ribbon-icon" data-icon="type" data-icon-size="20"></span>
              <span>Edit Text</span>
            </button>
            <button id="btn-edit-image" class="ribbon-btn" title="Edit images on this page" disabled aria-label="Edit images on this page">
              <span class="ribbon-icon" data-icon="image" data-icon-size="20"></span>
              <span>Edit Images</span>
            </button>
          </div>
          <div class="ribbon-group-label">Content</div>
        </div>
        <!-- Legal group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-bates" class="ribbon-btn ribbon-btn-lg" title="Bates Numbering" disabled aria-label="Bates Numbering">
              <span class="ribbon-icon" data-icon="hash" data-icon-size="20"></span>
              <span>Bates</span>
            </button>
            <button id="btn-headers-footers" class="ribbon-btn ribbon-btn-lg" title="Headers & Footers" disabled aria-label="Headers & Footers">
              <span class="ribbon-icon" data-icon="align-justify" data-icon-size="20"></span>
              <span>Header/Footer</span>
            </button>
          </div>
          <div class="ribbon-group-label">Legal</div>
        </div>
        <!-- Tools group -->
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-ocr" class="ribbon-btn ribbon-btn-lg" title="OCR â€” Recognize text in scanned pages" disabled aria-label="OCR â€” Recognize text in scanned pages">
              <span class="ribbon-icon" data-icon="file-scan" data-icon-size="20"></span>
              <span>OCR</span>
            </button>
          </div>
          <div class="ribbon-group-label">Tools</div>
        </div>
      </div>

      <!-- Ribbon: Annotate (hidden by default) -->
      <div class="ribbon-content" id="ribbon-annotate">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button class="ribbon-btn tool-btn" data-tool="select" title="Select (V)" aria-label="Select">
              <span class="ribbon-icon" data-icon="mouse-pointer"></span>
              <span>Select</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="text" title="Text (T)" disabled aria-label="Text">
              <span class="ribbon-icon" data-icon="type"></span>
              <span>Text</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="highlight" title="Highlight" disabled aria-label="Highlight">
              <span class="ribbon-icon" data-icon="highlighter"></span>
              <span>Highlight</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="underline" title="Underline" disabled aria-label="Underline">
              <span class="ribbon-icon" data-icon="underline"></span>
              <span>Underline</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="strikethrough" title="Strikethrough" disabled aria-label="Strikethrough">
              <span class="ribbon-icon" data-icon="strikethrough"></span>
              <span>Strike</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="draw" title="Draw (D)" disabled aria-label="Draw">
              <span class="ribbon-icon" data-icon="pencil"></span>
              <span>Draw</span>
            </button>
          </div>
          <div class="ribbon-row">
            <button class="ribbon-btn tool-btn" data-tool="shape" title="Shape" disabled aria-label="Shape">
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Shape</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="stamp" title="Stamp" disabled aria-label="Stamp">
              <span class="ribbon-icon" data-icon="stamp"></span>
              <span>Stamp</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="cover" title="Visual Cover" disabled aria-label="Visual Cover">
              <span class="ribbon-icon" data-icon="shield"></span>
              <span>Cover</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="redact" title="Redact" disabled aria-label="Redact">
              <span class="ribbon-icon" data-icon="shield-off"></span>
              <span>Redact</span>
            </button>
          </div>
          <div class="ribbon-group-label">Tools</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button class="ribbon-btn" id="btn-anno-image" aria-label="Insert image" disabled>
              <span class="ribbon-icon" data-icon="image"></span>
              <span>Image</span>
            </button>
            <button class="ribbon-btn sig-open-btn" title="Signature" disabled aria-label="Signature">
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button class="ribbon-btn tool-btn" data-tool="sticky-note" title="Sticky Note" disabled aria-label="Sticky Note">
              <span class="ribbon-icon" data-icon="sticky-note"></span>
              <span>Note</span>
            </button>
            <button class="ribbon-btn" disabled>
              <span class="ribbon-icon" data-icon="droplet"></span>
              <span>Watermark</span>
            </button>
            <button id="btn-exhibit-stamp" class="ribbon-btn" title="Exhibit Stamp" disabled aria-label="Exhibit Stamp">
              <span class="ribbon-icon" data-icon="gavel"></span>
              <span>Exhibit</span>
            </button>
          </div>
          <div class="ribbon-group-label">Insert</div>
        </div>
      </div>

      <!-- Ribbon: Forms (hidden by default) -->
      <div class="ribbon-content" id="ribbon-forms">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-form-text" class="ribbon-btn" title="Add Text Field" disabled aria-label="Add Text Field">
              <span class="ribbon-icon" data-icon="form-input"></span>
              <span>Text Field</span>
            </button>
            <button id="btn-form-checkbox" class="ribbon-btn" title="Add Checkbox" disabled aria-label="Add Checkbox">
              <span class="ribbon-icon" data-icon="check-circle"></span>
              <span>Checkbox</span>
            </button>
            <button id="btn-form-dropdown" class="ribbon-btn" title="Add Dropdown" disabled aria-label="Add Dropdown">
              <span class="ribbon-icon" data-icon="chevron-down"></span>
              <span>Dropdown</span>
            </button>
            <button id="btn-form-radio" class="ribbon-btn" title="Add Radio Button" disabled aria-label="Add Radio Button">
              <span class="ribbon-icon" data-icon="zap"></span>
              <span>Radio</span>
            </button>
            <button id="btn-form-signature" class="ribbon-btn" title="Add Signature Field" disabled aria-label="Add Signature Field">
              <span class="ribbon-icon" data-icon="pen-tool"></span>
              <span>Signature</span>
            </button>
            <button id="btn-form-button" class="ribbon-btn" title="Add Push Button" disabled aria-label="Add Push Button">
              <span class="ribbon-icon" data-icon="square"></span>
              <span>Button</span>
            </button>
          </div>
          <div class="ribbon-group-label">Create Fields</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-form-import" class="ribbon-btn" title="Import Form Data" disabled aria-label="Import Form Data">
              <span class="ribbon-icon" data-icon="upload"></span>
              <span>Import</span>
            </button>
            <button id="btn-form-export" class="ribbon-btn" title="Export Form Data" disabled aria-label="Export Form Data">
              <span class="ribbon-icon" data-icon="save"></span>
              <span>Export</span>
            </button>
            <button id="btn-form-tab-order" class="ribbon-btn" title="Set Tab Order" disabled aria-label="Set Tab Order">
              <span class="ribbon-icon" data-icon="list-ordered"></span>
              <span>Tab Order</span>
            </button>
            <button id="btn-form-flatten" class="ribbon-btn" title="Flatten Form Fields" disabled aria-label="Flatten Form Fields">
              <span class="ribbon-icon" data-icon="layers"></span>
              <span>Flatten</span>
            </button>
          </div>
          <div class="ribbon-group-label">Form Data</div>
        </div>
      </div>

      <!-- Ribbon: Security (hidden by default) -->
      <div class="ribbon-content" id="ribbon-security">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-encrypt" class="ribbon-btn ribbon-btn-lg" title="Password Protect PDF" disabled aria-label="Password Protect PDF">
              <span class="ribbon-icon" data-icon="key" data-icon-size="20"></span>
              <span>Encrypt</span>
            </button>
            <button id="btn-metadata" class="ribbon-btn ribbon-btn-lg" title="Edit/Remove Metadata" disabled aria-label="Edit/Remove Metadata">
              <span class="ribbon-icon" data-icon="file-lock" data-icon-size="20"></span>
              <span>Metadata</span>
            </button>
            <button id="btn-sanitize" class="ribbon-btn ribbon-btn-lg" title="Full Document Sanitization" disabled aria-label="Full Document Sanitization">
              <span class="ribbon-icon" data-icon="shield-check" data-icon-size="20"></span>
              <span>Sanitize</span>
            </button>
          </div>
          <div class="ribbon-group-label">Protect</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-redact-search" class="ribbon-btn ribbon-btn-lg" title="Search & Redact Sensitive Data" disabled aria-label="Search & Redact Sensitive Data">
              <span class="ribbon-icon" data-icon="scan" data-icon-size="20"></span>
              <span>Redact Search</span>
            </button>
          </div>
          <div class="ribbon-group-label">Redaction</div>
        </div>
      </div>

      <!-- Ribbon: Tools (hidden by default) -->
      <div class="ribbon-content" id="ribbon-tools">
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-export-image" class="ribbon-btn ribbon-btn-lg" title="Export Pages to Images" disabled aria-label="Export Pages to Images">
              <span class="ribbon-icon" data-icon="file-image" data-icon-size="20"></span>
              <span>Export Image</span>
            </button>
            <button id="btn-create-from-images" class="ribbon-btn ribbon-btn-lg" title="Create PDF from Images" disabled aria-label="Create PDF from Images">
              <span class="ribbon-icon" data-icon="image" data-icon-size="20"></span>
              <span>Images â†’ PDF</span>
            </button>
            <button id="btn-optimize" class="ribbon-btn ribbon-btn-lg" title="Optimize/Compress PDF" disabled aria-label="Optimize/Compress PDF">
              <span class="ribbon-icon" data-icon="shrink" data-icon-size="20"></span>
              <span>Optimize</span>
            </button>
          </div>
          <div class="ribbon-group-label">Export</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-compare" class="ribbon-btn ribbon-btn-lg" title="Compare Two PDFs" disabled aria-label="Compare Two PDFs">
              <span class="ribbon-icon" data-icon="git-compare" data-icon-size="20"></span>
              <span>Compare</span>
            </button>
          </div>
          <div class="ribbon-group-label">Compare</div>
        </div>
        <div class="ribbon-group">
          <div class="ribbon-row">
            <button id="btn-comment-summary" class="ribbon-btn ribbon-btn-lg" title="Export Annotation Summary" disabled aria-label="Export Annotation Summary">
              <span class="ribbon-icon" data-icon="file-text" data-icon-size="20"></span>
              <span>Comments</span>
            </button>
            <button id="btn-flatten-annotations" class="ribbon-btn ribbon-btn-lg" title="Flatten Annotations into PDF" disabled aria-label="Flatten Annotations into PDF">
              <span class="ribbon-icon" data-icon="layers" data-icon-size="20"></span>
              <span>Flatten</span>
            </button>
          </div>
          <div class="ribbon-group-label">Review</div>
        </div>
      </div>

    </div>

    <!-- â”€â”€ Main Content â”€â”€ -->
    <div id="main-container">

      <!-- Left Sidebar -->
      <aside id="sidebar" aria-label="Document sidebar">
        <div id="sidebar-tabs">
          <button class="sidebar-tab active" data-sidebar="pages" title="Pages" aria-label="Pages">
            <span data-icon="layout-grid" data-icon-size="14"></span>
            <span class="sidebar-tab-label">Pages</span>
          </button>
          <button class="sidebar-tab" data-sidebar="bookmarks" title="Bookmarks" aria-label="Bookmarks">
            <span data-icon="bookmark" data-icon-size="14"></span>
            <span class="sidebar-tab-label">Bookmarks</span>
          </button>
          <button class="sidebar-tab" data-sidebar="notes" title="Notes" aria-label="Notes">
            <span data-icon="message-square" data-icon-size="14"></span>
            <span class="sidebar-tab-label">Notes</span>
          </button>
          <button id="btn-toggle-sidebar" class="sidebar-collapse" title="Toggle Sidebar" aria-label="Toggle Sidebar" data-icon="panel-left-close"></button>
        </div>
        <div class="sidebar-panel active" id="sidebar-pages">
          <div id="thumbnail-list"></div>
        </div>
        <div class="sidebar-panel" id="sidebar-bookmarks">
          <div class="sidebar-empty">
            <span data-icon="bookmark" data-icon-size="24"></span>
            <p>No bookmarks</p>
            <p class="sidebar-empty-hint">Bookmarks from the PDF outline will appear here.</p>
          </div>
        </div>
        <div class="sidebar-panel" id="sidebar-notes">
          <div class="sidebar-empty">
            <span data-icon="message-square" data-icon-size="24"></span>
            <p>No notes yet</p>
            <p class="sidebar-empty-hint">Add annotations to pages to see notes here.</p>
          </div>
        </div>
      </aside>

      <!-- Canvas Area -->
      <main id="canvas-area" role="main" aria-label="PDF document view">
        <!-- Find & Replace Bar (Ctrl+F / Ctrl+H) -->
        <div id="find-bar" class="find-bar hidden">
          <div class="find-bar-row">
            <span class="find-icon" data-icon="search" data-icon-size="14"></span>
            <input type="text" id="find-input" class="find-input" placeholder="Find in documentâ€¦ (Ctrl+F)" autocomplete="off" spellcheck="false">
            <span id="find-match-count" class="find-match-count" aria-live="polite"></span>
            <button id="find-prev" class="find-nav-btn" title="Previous (Shift+Enter)" aria-label="Previous match">
              <span data-icon="chevron-up" data-icon-size="14"></span>
            </button>
            <button id="find-next" class="find-nav-btn" title="Next (Enter)" aria-label="Next match">
              <span data-icon="chevron-down" data-icon-size="14"></span>
            </button>
            <label class="find-case-toggle" title="Match Case">
              <input type="checkbox" id="find-case-sensitive" aria-label="Find Case Sensitive">
              <span>Aa</span>
            </label>
            <button id="find-replace-toggle" class="find-nav-btn" title="Toggle Replace (Ctrl+H)" aria-label="Toggle replace">
              <span data-icon="replace" data-icon-size="14">â†”</span>
            </button>
            <button id="find-close" class="find-close-btn" title="Close (Esc)" aria-label="Close find bar">
              <span data-icon="x" data-icon-size="14"></span>
            </button>
          </div>
          <div id="find-replace-row" class="find-replace-row hidden">
            <input type="text" id="replace-input" class="find-input" placeholder="Replace withâ€¦" autocomplete="off" spellcheck="false">
            <button id="replace-one" class="find-replace-btn" title="Replace current match" aria-label="Replace">Replace</button>
            <button id="replace-all" class="find-replace-btn" title="Replace all matches" aria-label="Replace all">All</button>
          </div>
        </div>

        <div id="page-container">
          <canvas id="pdf-canvas"></canvas>
          <div id="text-layer"></div>
          <div id="fabric-canvas-wrapper">
            <canvas id="fabric-canvas"></canvas>
          </div>
          <!-- Visual Crop Overlay (inside page-container for positioning) -->
          <div id="crop-overlay" class="crop-overlay hidden">
            <div class="crop-shade crop-shade-top"></div>
            <div class="crop-shade crop-shade-bottom"></div>
            <div class="crop-shade crop-shade-left"></div>
            <div class="crop-shade crop-shade-right"></div>
            <div class="crop-selection">
              <div class="crop-handle" data-handle="nw"></div>
              <div class="crop-handle" data-handle="n"></div>
              <div class="crop-handle" data-handle="ne"></div>
              <div class="crop-handle" data-handle="e"></div>
              <div class="crop-handle" data-handle="se"></div>
              <div class="crop-handle" data-handle="s"></div>
              <div class="crop-handle" data-handle="sw"></div>
              <div class="crop-handle" data-handle="w"></div>
            </div>
          </div>
        </div>

        <!-- Floating Annotation Toolbar -->
        <div id="floating-toolbar" class="floating-toolbar hidden">
          <button class="float-btn active" data-tool="select" title="Select (V)" aria-label="Select">
            <span data-icon="mouse-pointer" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="hand" title="Hand Tool (H)" aria-label="Hand Tool">
            <span data-icon="hand" data-icon-size="16"></span>
          </button>
          <div class="float-sep"></div>
          <button class="float-btn" data-tool="text" title="Text (T)" aria-label="Text">
            <span data-icon="type" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="highlight" title="Highlight (L)" aria-label="Highlight">
            <span data-icon="highlighter" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="underline" title="Underline" aria-label="Underline">
            <span data-icon="underline" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="strikethrough" title="Strikethrough" aria-label="Strikethrough">
            <span data-icon="strikethrough" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="draw" title="Draw (D)" aria-label="Draw">
            <span data-icon="pencil" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="shape" title="Shape (R)" aria-label="Shape">
            <span data-icon="square" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="cover" title="Visual Cover" aria-label="Visual Cover">
            <span data-icon="shield" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="redact" title="Redact" aria-label="Redact">
            <span data-icon="shield-off" data-icon-size="16"></span>
          </button>
          <div class="float-sep"></div>
          <button class="float-btn" data-tool="stamp" title="Stamp" aria-label="Stamp">
            <span data-icon="stamp" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="image" title="Image" aria-label="Image">
            <span data-icon="image" data-icon-size="16"></span>
          </button>
          <button class="float-btn sig-open-btn" title="Signature" aria-label="Signature">
            <span data-icon="pen-tool" data-icon-size="16"></span>
          </button>
          <button class="float-btn" data-tool="sticky-note" title="Sticky Note" aria-label="Sticky Note">
            <span data-icon="sticky-note" data-icon-size="16"></span>
          </button>
        </div>
      </main>

      <!-- Properties Panel (right) -->
      <aside id="properties-panel" class="hidden" aria-label="Properties panel">
        <div class="panel-header">
          <span class="panel-title">Properties</span>
          <button id="btn-close-panel" class="panel-close" title="Close Panel" aria-label="Close properties panel" data-icon="x" data-icon-size="14"></button>
        </div>
        <div class="panel-body">

          <!-- Tool Properties (dynamic â€” changes per active tool) -->
          <div class="panel-section" id="panel-tool-props">
            <div class="panel-section-title">Highlight Tool</div>
            <div class="prop-row">
              <span class="prop-label">Color</span>
              <div class="prop-color-row">
                <div class="color-swatch active" style="background:#fde047;" data-color="#fde047"></div>
                <div class="color-swatch" style="background:#86efac;" data-color="#86efac"></div>
                <div class="color-swatch" style="background:#93c5fd;" data-color="#93c5fd"></div>
                <div class="color-swatch" style="background:#fca5a5;" data-color="#fca5a5"></div>
                <div class="color-swatch" style="background:#c4b5fd;" data-color="#c4b5fd"></div>
                <div class="color-swatch" style="background:#fdba74;" data-color="#fdba74"></div>
              </div>
            </div>
            <div class="prop-row">
              <span class="prop-label">Opacity</span>
              <input type="range" class="prop-slider" id="prop-opacity" min="10" max="100" value="40" aria-label="Prop Opacity">
              <span class="prop-slider-value" id="prop-opacity-value">40%</span>
            </div>
          </div>

          <!-- Document Info -->
          <div class="panel-section" id="panel-doc-info">
            <div class="panel-section-title">Document Info</div>
            <div class="prop-row">
              <span class="prop-label">Title</span>
              <input type="text" class="prop-input" id="prop-doc-title" placeholder="â€”">
            </div>
            <div class="prop-row">
              <span class="prop-label">Author</span>
              <input type="text" class="prop-input" id="prop-doc-author" placeholder="â€”">
            </div>
            <div class="prop-row">
              <span class="prop-label">Pages</span>
              <input type="text" class="prop-input prop-readonly" id="prop-doc-pages" value="â€”" readonly aria-label="Prop Doc Pages">
            </div>
            <div class="prop-row">
              <span class="prop-label">Size</span>
              <input type="text" class="prop-input prop-readonly" id="prop-doc-size" value="â€”" readonly aria-label="Prop Doc Size">
            </div>
          </div>

          <!-- Page Settings -->
          <div class="panel-section" id="panel-page-settings">
            <div class="panel-section-title">Page Settings</div>
            <div class="prop-row">
              <span class="prop-label">Size</span>
              <select class="prop-select" id="prop-page-size" aria-label="Prop Page Size">
                <option>Letter (8.5 x 11)</option>
                <option>A4 (210 x 297mm)</option>
                <option>Legal (8.5 x 14)</option>
              </select>
            </div>
            <div class="prop-row">
              <span class="prop-label">Orientation</span>
              <select class="prop-select" id="prop-page-orient" aria-label="Prop Page Orient">
                <option>Portrait</option>
                <option>Landscape</option>
              </select>
            </div>
          </div>

          <!-- Sticky Note Properties (hidden by default, shown when a note is selected) -->
          <div class="panel-section hidden" id="panel-note-props">
            <div class="panel-section-title">Note Text</div>
            <textarea id="prop-note-text" rows="4" placeholder="Type note textâ€¦"
              class="note-textarea" aria-label="Prop Note Text"></textarea>
            <div class="prop-row mt-8">
              <span class="prop-label">Color</span>
              <div class="prop-color-row" id="note-color-swatches">
                <div class="color-swatch active" style="background:#fff9c4;" data-note-color="yellow" title="Yellow"></div>
                <div class="color-swatch" style="background:#c8e6c9;" data-note-color="green" title="Green"></div>
                <div class="color-swatch" style="background:#bbdefb;" data-note-color="blue" title="Blue"></div>
                <div class="color-swatch" style="background:#f8bbd0;" data-note-color="pink" title="Pink"></div>
                <div class="color-swatch" style="background:#ffe0b2;" data-note-color="orange" title="Orange"></div>
              </div>
            </div>
          </div>

          <!-- Annotations on Current Page -->
          <div class="panel-section" id="panel-annotations">
            <div class="panel-section-title">Annotations on Page <span id="panel-anno-page">1</span></div>
            <div id="panel-anno-list" class="anno-list">
              <div class="sidebar-empty">
                <p>No annotations yet</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress bar (hidden by default, shown during OCR etc.) -->
        <div id="panel-progress" class="progress-section hidden">
          <div class="progress-label">
            <span id="progress-task">Processing</span>
            <span id="progress-detail"></span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width:0%;"></div>
          </div>
        </div>
      </aside>
    </div>

    <!-- â”€â”€ Page Navigation â”€â”€ -->
    <nav id="page-nav" aria-label="Page navigation">
      <button id="btn-first-page" class="page-nav-btn" title="First Page (Home)" aria-label="First Page" disabled>
        <span data-icon="chevrons-left" data-icon-size="14"></span>
      </button>
      <button id="btn-prev-page" class="page-nav-btn" title="Previous Page (â†)" aria-label="Previous Page" disabled>
        <span data-icon="chevron-left" data-icon-size="14"></span>
      </button>
      <input id="page-input" class="page-nav-input" type="number" min="1" value="1" aria-label="Current page number">
      <span class="page-nav-text">of <span id="total-pages">0</span></span>
      <button id="btn-next-page" class="page-nav-btn" title="Next Page (â†’)" aria-label="Next Page" disabled>
        <span data-icon="chevron-right" data-icon-size="14"></span>
      </button>
      <button id="btn-last-page" class="page-nav-btn" title="Last Page (End)" aria-label="Last Page" disabled>
        <span data-icon="chevrons-right" data-icon-size="14"></span>
      </button>
      <div class="page-nav-sep"></div>
      <span class="page-nav-label">Continuous scroll</span>
    </nav>

    <!-- â”€â”€ Status Bar â”€â”€ -->
    <footer id="status-bar">
      <span id="statusbar-filename">No file loaded</span>
      <div class="status-sep"></div>
      <span id="status-pages-size"></span>
      <div class="status-sep"></div>
      <span id="status-badge-encrypted" class="status-badge encrypted hidden">
        <span data-icon="lock" data-icon-size="10"></span> Encrypted
      </span>
      <span id="status-badge-tagged" class="status-badge tagged hidden">Tagged</span>
      <span id="status-tool" class="status-badge hidden"></span>
      <span id="status-unsaved" class="status-unsaved hidden" title="Unsaved changes"></span>
      <div class="status-right">
        <span id="status-offline" class="status-badge status-offline hidden">
          <span data-icon="wifi-off" data-icon-size="10"></span> Offline
        </span>
        <span id="status-ocr" class="status-badge status-badge-ocr hidden">OCR âœ“</span>
        <span id="status-bates" class="hidden">Bates: â€”</span>
        <div class="status-sep"></div>
        <div class="zoom-control">
          <button class="zoom-btn" id="status-zoom-out" title="Zoom Out" aria-label="Zoom Out">
            <span data-icon="minus" data-icon-size="12"></span>
          </button>
          <span class="zoom-val" id="status-zoom" title="Click to reset zoom">100%</span>
          <button class="zoom-btn" id="status-zoom-in" title="Zoom In" aria-label="Zoom In">
            <span data-icon="plus" data-icon-size="12"></span>
          </button>
        </div>
      </div>
    </footer>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Toast Container â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="toast-container"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Loading Overlay â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="loading-overlay" class="hidden" role="alert" aria-live="assertive">
    <div class="spinner"></div>
    <span id="loading-text" class="loading-text">Processing...</span>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Merge Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="merge-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Merge PDFs">
    <div class="modal">
      <div class="modal-header">
        <h2>Merge PDFs</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="merge">&times;</button>
      </div>
      <div class="modal-body">
        <div id="merge-drop-zone" class="modal-drop-zone modal-form-section">
          <p>Drop PDF files here or click to add</p>
          <input type="file" id="merge-file-input" accept=".pdf" multiple hidden aria-label="Merge File Input">
        </div>
        <ul class="file-list" id="merge-file-list"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="merge">Cancel</button>
        <button class="btn-primary" id="btn-merge-execute" disabled>Merge Files</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Split Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="split-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Split PDF">
    <div class="modal">
      <div class="modal-header">
        <h2>Split PDF</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="split">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Enter page ranges separated by commas. Example: 1-3, 5, 7-12
        </p>
        <input type="text" id="split-range-input" class="modal-form-input"
          placeholder="e.g. 1-3, 5, 7-12">
        <div id="split-preview" class="modal-form-hint mt-12"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="split">Cancel</button>
        <button class="btn-primary" id="btn-split-execute" disabled>Split</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Watermark Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="watermark-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Add Watermark">
    <div class="modal">
      <div class="modal-header">
        <h2>Add Watermark</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="watermark">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-stack">
          <div>
            <label class="modal-form-label" for="watermark-text">Text</label>
            <input type="text" id="watermark-text" value="CONFIDENTIAL" class="modal-form-input"
              placeholder="Watermark text">
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="modal-form-label" for="watermark-size">Font Size</label>
              <input type="number" id="watermark-size" value="60" min="10" max="200" class="modal-form-input" aria-label="Watermark Size">
            </div>
            <div>
              <label class="modal-form-label" for="watermark-rotation">Rotation (&deg;)</label>
              <input type="number" id="watermark-rotation" value="-45" min="-180" max="180" class="modal-form-input" aria-label="Watermark Rotation">
            </div>
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="modal-form-label" for="watermark-opacity">Opacity</label>
              <input type="range" id="watermark-opacity" min="0.05" max="0.5" step="0.05" value="0.15"
                class="w-full" aria-label="Watermark Opacity">
              <span id="watermark-opacity-value" class="range-value-label">15%</span>
            </div>
            <div>
              <label class="modal-form-label" for="watermark-color">Color</label>
              <input type="color" id="watermark-color" value="#888888" class="modal-form-color" aria-label="Watermark Color">
            </div>
          </div>
          <div>
            <label class="modal-form-label" for="watermark-pages">Apply to</label>
            <select id="watermark-pages" class="modal-form-input" aria-label="Watermark Pages">
              <option value="all">All Pages</option>
              <option value="current">Current Page Only</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="watermark">Cancel</button>
        <button class="btn-primary" id="btn-watermark-execute">Apply Watermark</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Bates Numbering Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="bates-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Bates Numbering">
    <div class="modal">
      <div class="modal-header">
        <h2>Bates Numbering</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="bates">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-stack">
          <div class="modal-form-grid">
            <div>
              <label class="bates-label" for="bates-prefix">Prefix</label>
              <input type="text" id="bates-prefix" value="" placeholder="e.g. DOC-"
                class="bates-field">
            </div>
            <div>
              <label class="bates-label" for="bates-suffix">Suffix</label>
              <input type="text" id="bates-suffix" value="" placeholder="e.g. -R1"
                class="bates-field">
            </div>
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="bates-label" for="bates-start">Start Number</label>
              <input type="number" id="bates-start" value="1" min="0"
                class="bates-field" aria-label="Bates Start">
            </div>
            <div>
              <label class="bates-label" for="bates-pad">Zero Padding (digits)</label>
              <input type="number" id="bates-pad" value="6" min="1" max="12"
                class="bates-field" aria-label="Bates Pad">
            </div>
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="bates-label" for="bates-position">Position</label>
              <select id="bates-position" class="bates-field" aria-label="Bates Position">
                <option value="bottom-center">Bottom Center</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-right">Bottom Right</option>
                <option value="top-center">Top Center</option>
                <option value="top-left">Top Left</option>
                <option value="top-right">Top Right</option>
              </select>
            </div>
            <div>
              <label class="bates-label" for="bates-font-size">Font Size</label>
              <input type="number" id="bates-font-size" value="10" min="6" max="36"
                class="bates-field" aria-label="Bates Font Size">
            </div>
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="bates-label" for="bates-color">Color</label>
              <input type="color" id="bates-color" value="#000000" class="modal-form-color" aria-label="Bates Color">
            </div>
            <div>
              <label class="bates-label" for="bates-page-range">Page Range</label>
              <select id="bates-page-range" class="bates-field" aria-label="Bates Page Range">
                <option value="all">All Pages</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
          </div>
          <div id="bates-custom-range" class="hidden">
            <label class="bates-label" for="bates-range-input">Pages (e.g. 1-5, 8, 10-12)</label>
            <input type="text" id="bates-range-input" placeholder="1-5, 8, 10-12"
              class="bates-field">
          </div>
          <div class="bates-preview-box">
            <span class="bates-label">Preview</span>
            <span id="bates-preview" class="bates-preview-text">000001</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="bates">Cancel</button>
        <button class="btn-primary" id="btn-bates-execute">Apply Bates Numbers</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â• Headers & Footers Modal â•â•â•â•â•â•â• -->
  <div id="hf-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Headers and Footers">
    <div class="modal-panel modal-w580">
      <div class="modal-header">
        <h3>Headers &amp; Footers</h3>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="hf">&times;</button>
      </div>
      <div class="modal-body">

        <!-- Token helper -->
        <div class="modal-form-section">
          <label class="bates-label">Insert Token:</label>
          <div class="flex-wrap-row">
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{page}">Page #</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{pages}">Total Pages</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{date}">Date</button>
            <button class="btn-secondary btn-sm hf-token-btn" data-token="{filename}">Filename</button>
          </div>
        </div>

        <!-- Header row -->
        <div class="modal-form-section">
          <label class="modal-form-label-bold">Header</label>
          <div class="modal-form-grid-3 gap-sm">
            <div>
              <label class="bates-label" for="hf-top-left">Left</label>
              <input id="hf-top-left" class="bates-field hf-zone" placeholder="e.g. {filename}">
            </div>
            <div>
              <label class="bates-label" for="hf-top-center">Center</label>
              <input id="hf-top-center" class="bates-field hf-zone" placeholder="e.g. Confidential">
            </div>
            <div>
              <label class="bates-label" for="hf-top-right">Right</label>
              <input id="hf-top-right" class="bates-field hf-zone" placeholder="e.g. {date}">
            </div>
          </div>
        </div>

        <!-- Footer row -->
        <div class="modal-form-section">
          <label class="modal-form-label-bold">Footer</label>
          <div class="modal-form-grid-3 gap-sm">
            <div>
              <label class="bates-label" for="hf-bottom-left">Left</label>
              <input id="hf-bottom-left" class="bates-field hf-zone" placeholder="" aria-label="Hf Bottom Left">
            </div>
            <div>
              <label class="bates-label" for="hf-bottom-center">Center</label>
              <input id="hf-bottom-center" class="bates-field hf-zone" placeholder="e.g. Page {page} of {pages}">
            </div>
            <div>
              <label class="bates-label" for="hf-bottom-right">Right</label>
              <input id="hf-bottom-right" class="bates-field hf-zone" placeholder="" aria-label="Hf Bottom Right">
            </div>
          </div>
        </div>

        <!-- Options row -->
        <div class="modal-form-section">
          <div class="modal-form-grid-3">
            <div>
              <label class="bates-label" for="hf-font-size">Font Size</label>
              <input id="hf-font-size" type="number" class="bates-field" value="10" min="6" max="36" aria-label="Hf Font Size">
            </div>
            <div>
              <label class="bates-label" for="hf-color">Color</label>
              <input id="hf-color" type="color" class="bates-field modal-form-color" value="#000000" aria-label="Hf Color">
            </div>
            <div>
              <label class="bates-label" for="hf-page-range">Page Range</label>
              <select id="hf-page-range" class="bates-field" aria-label="Hf Page Range">
                <option value="all">All Pages</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Custom range (hidden by default) -->
        <div id="hf-custom-range" class="hidden modal-form-section">
          <label class="bates-label" for="hf-range-input">Pages (e.g. 1-5, 8, 10-12)</label>
          <input id="hf-range-input" class="bates-field" placeholder="1-5, 8, 10-12">
        </div>

        <!-- Preview -->
        <div class="bates-preview-box">
          <span class="modal-preview-title">Preview (page 1 of 10)</span>
          <div id="hf-preview" class="hf-preview-grid">
            <span id="hf-prev-tl" class="hf-preview-cell hf-preview-left">â€”</span>
            <span id="hf-prev-tc" class="hf-preview-cell hf-preview-center">â€”</span>
            <span id="hf-prev-tr" class="hf-preview-cell hf-preview-right">â€”</span>
            <span id="hf-prev-bl" class="hf-preview-cell hf-preview-left">â€”</span>
            <span id="hf-prev-bc" class="hf-preview-cell hf-preview-center">â€”</span>
            <span id="hf-prev-br" class="hf-preview-cell hf-preview-right">â€”</span>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="hf">Cancel</button>
        <button class="btn-primary" id="btn-hf-execute">Apply Headers &amp; Footers</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â• Crop Control Bar (visual crop overlay is in #page-container) â•â•â•â•â•â•â• -->
  <div id="crop-bar" class="crop-bar hidden">
    <span id="crop-bar-info" class="crop-bar-info">Drag handles to adjust crop</span>
    <div class="crop-bar-presets">
      <button class="btn-sm btn-secondary crop-preset" data-top="36" data-bottom="36" data-left="36" data-right="36">0.5"</button>
      <button class="btn-sm btn-secondary crop-preset" data-top="72" data-bottom="72" data-left="72" data-right="72">1"</button>
    </div>
    <select id="crop-scope" class="crop-bar-scope" aria-label="Crop Scope">
      <option value="current">Current Page</option>
      <option value="all">All Pages</option>
    </select>
    <button class="btn-primary btn-sm" id="btn-crop-execute">Apply Crop</button>
    <button class="btn-secondary btn-sm" id="btn-crop-cancel">Cancel</button>
  </div>
  <!-- Hidden inputs for crop values (used internally) -->
  <input type="hidden" id="crop-top" value="0">
  <input type="hidden" id="crop-bottom" value="0">
  <input type="hidden" id="crop-left" value="0">
  <input type="hidden" id="crop-right" value="0">
  <!-- Keep modal backdrop stub for close-modal handler compatibility -->
  <div id="crop-modal-backdrop" class="hidden"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Signature Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="signature-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Digital Signature">
    <div class="modal-panel modal-md">
      <div class="modal-header">
        <h2>Signature</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="signature">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tabs -->
        <div class="sig-tabs-bar">
          <button class="sig-tab active" data-sig-tab="draw">Draw</button>
          <button class="sig-tab" data-sig-tab="type">Type</button>
          <button class="sig-tab" data-sig-tab="upload">Upload</button>
        </div>

        <!-- Draw Pane -->
        <div class="sig-pane" data-sig-pane="draw">
          <div class="sig-canvas-wrap">
            <canvas id="sig-draw-canvas" width="420" height="160"></canvas>
          </div>
          <button id="sig-draw-clear" class="btn-secondary btn-sm mt-8">Clear</button>
        </div>

        <!-- Type Pane -->
        <div class="sig-pane hidden" data-sig-pane="type">
          <input type="text" id="sig-type-input" class="sig-type-field" placeholder="Your name">
          <div>
            <label class="modal-form-label" for="sig-type-font">Font Style</label>
            <select id="sig-type-font" class="modal-form-input" aria-label="Sig Type Font">
              <option value="Dancing Script">Cursive (Dancing Script)</option>
              <option value="Caveat">Handwritten (Caveat)</option>
              <option value="Great Vibes">Elegant (Great Vibes)</option>
              <option value="Sacramento">Flowing (Sacramento)</option>
            </select>
          </div>
        </div>

        <!-- Upload Pane -->
        <div class="sig-pane hidden" data-sig-pane="upload">
          <div class="modal-drop-zone">
            <label for="sig-upload-input" class="sig-upload-label">
              Choose an image file
            </label>
            <input type="file" id="sig-upload-input" accept="image/png,image/jpeg,image/gif,image/webp" hidden aria-label="Sig Upload Input">
            <p class="drop-hint">PNG with transparent background recommended</p>
          </div>
          <img id="sig-upload-preview" class="hidden sig-upload-img" alt="Preview">
        </div>

        <!-- Saved Signatures -->
        <div class="sig-saved-section">
          <div class="sig-saved-title">Saved Signatures</div>
          <div id="sig-saved-list" class="sig-saved-list"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="btn-sig-save">Save</button>
        <button class="btn-secondary" data-close-modal="signature">Cancel</button>
        <button class="btn-primary" id="btn-sig-insert">Insert</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for image insertion -->
  <input type="file" id="image-file-input" accept="image/png,image/jpeg,image/gif,image/webp" hidden aria-label="Image File Input">

  <!-- OCR Modal -->
  <div id="ocr-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="OCR Text Recognition">
    <div class="modal modal-w440">
      <div class="modal-header">
        <h2>OCR â€” Text Recognition</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="ocr">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Recognize text in scanned pages so you can search and select text. Uses Tesseract.js (runs locally in your browser).
        </p>

        <!-- Page selection -->
        <div class="modal-form-section">
          <label class="modal-form-label-bold">Pages to OCR</label>
          <div class="modal-radio-list">
            <label>
              <input type="radio" name="ocr-scope" value="current" checked> Current page
            </label>
            <label>
              <input type="radio" name="ocr-scope" value="all"> All pages
            </label>
            <label>
              <input type="radio" name="ocr-scope" value="range"> Page range
              <input type="text" id="ocr-range-input" placeholder="e.g. 1-5, 8"
                class="modal-form-input ocr-range-input">
            </label>
          </div>
        </div>

        <!-- Progress area (hidden until running) -->
        <div id="ocr-progress-area" class="hidden mt-12">
          <div class="modal-progress-header">
            <span id="ocr-progress-label">Starting...</span>
            <span id="ocr-progress-pct">0%</span>
          </div>
          <div class="modal-progress-bar-wrapper">
            <div id="ocr-progress-bar" class="modal-progress-bar-fill" style="width:0%;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="ocr">Cancel</button>
        <button class="btn-primary" id="btn-ocr-run">Run OCR</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Encrypt Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="encrypt-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Encrypt PDF">
    <div class="modal modal-w460">
      <div class="modal-header">
        <h2>Password Protect PDF</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="encrypt">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-stack">
          <div>
            <label class="bates-label" for="encrypt-user-pw">User Password (to open)</label>
            <input type="password" id="encrypt-user-pw" class="bates-field" placeholder="Leave blank for no open password">
          </div>
          <div>
            <label class="bates-label" for="encrypt-owner-pw">Owner Password (to edit)</label>
            <input type="password" id="encrypt-owner-pw" class="bates-field" placeholder="Required">
          </div>
          <div>
            <label class="bates-label">Permissions</label>
            <div class="modal-checkbox-list">
              <label><input type="checkbox" id="perm-print" checked aria-label="Perm Print"> Allow Printing</label>
              <label><input type="checkbox" id="perm-copy" checked aria-label="Perm Copy"> Allow Copying</label>
              <label><input type="checkbox" id="perm-modify" checked aria-label="Perm Modify"> Allow Modifying</label>
              <label><input type="checkbox" id="perm-annotate" checked aria-label="Perm Annotate"> Allow Annotating</label>
              <label><input type="checkbox" id="perm-fill-forms" aria-label="Perm Fill Forms"> Allow Form Filling Only</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="encrypt">Cancel</button>
        <button class="btn-primary" id="btn-encrypt-execute">Encrypt PDF</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Metadata Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="metadata-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Document Metadata">
    <div class="modal modal-md">
      <div class="modal-header">
        <h2>Document Metadata</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="metadata">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-stack">
          <div>
            <label class="bates-label" for="meta-title">Title</label>
            <input type="text" id="meta-title" class="bates-field" placeholder="Document title">
          </div>
          <div>
            <label class="bates-label" for="meta-author">Author</label>
            <input type="text" id="meta-author" class="bates-field" placeholder="Author name">
          </div>
          <div>
            <label class="bates-label" for="meta-subject">Subject</label>
            <input type="text" id="meta-subject" class="bates-field" placeholder="Document subject">
          </div>
          <div>
            <label class="bates-label" for="meta-keywords">Keywords</label>
            <input type="text" id="meta-keywords" class="bates-field" placeholder="keyword1, keyword2">
          </div>
          <div>
            <label class="bates-label" for="meta-creator">Creator</label>
            <input type="text" id="meta-creator" class="bates-field" readonly aria-label="Meta Creator">
          </div>
          <div>
            <label class="bates-label" for="meta-producer">Producer</label>
            <input type="text" id="meta-producer" class="bates-field" readonly aria-label="Meta Producer">
          </div>
          <div>
            <label class="bates-label" for="meta-creation-date">Creation Date</label>
            <input type="text" id="meta-creation-date" class="bates-field" readonly aria-label="Meta Creation Date">
          </div>
          <div>
            <label class="bates-label" for="meta-mod-date">Modification Date</label>
            <input type="text" id="meta-mod-date" class="bates-field" readonly aria-label="Meta Mod Date">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary btn-danger-text" id="btn-meta-remove">Remove All Metadata</button>
        <button class="btn-secondary" data-close-modal="metadata">Cancel</button>
        <button class="btn-primary" id="btn-meta-save">Save Metadata</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Redaction Search Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="redact-search-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Search and Redact">
    <div class="modal modal-w520">
      <div class="modal-header">
        <h2>Search &amp; Redact</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="redact-search">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Auto-detect and redact sensitive data. Select patterns to search for:
        </p>
        <div class="modal-checkbox-list modal-form-section">
          <label><input type="checkbox" class="redact-pattern-cb" value="ssn"> Social Security Numbers (XXX-XX-XXXX)</label>
          <label><input type="checkbox" class="redact-pattern-cb" value="creditCard"> Credit Card Numbers</label>
          <label><input type="checkbox" class="redact-pattern-cb" value="email"> Email Addresses</label>
          <label><input type="checkbox" class="redact-pattern-cb" value="phone"> Phone Numbers</label>
          <label><input type="checkbox" class="redact-pattern-cb" value="date"> Dates</label>
          <label><input type="checkbox" class="redact-pattern-cb" value="custom"> Custom Pattern</label>
        </div>
        <div id="redact-custom-row" class="hidden modal-form-section">
          <label class="bates-label" for="redact-custom-input">Custom Regex or Text</label>
          <input type="text" id="redact-custom-input" class="bates-field" placeholder="e.g. ACME Corp or \\d{3}-\\d{4}">
        </div>
        <div id="redact-results" class="hidden modal-preview-box modal-scrollable-list">
          <div id="redact-results-list" class="modal-text-sm"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="redact-search">Cancel</button>
        <button class="btn-primary" id="btn-redact-search-execute">Search</button>
        <button class="btn-primary hidden" id="btn-redact-apply">Apply Redactions</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Export to Image Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="export-image-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Export as Image">
    <div class="modal modal-w420">
      <div class="modal-header">
        <h2>Export Pages to Image</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="export-image">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-stack">
          <div>
            <label class="bates-label" for="export-img-scope">Pages</label>
            <select id="export-img-scope" class="bates-field" aria-label="Export Img Scope">
              <option value="current">Current Page</option>
              <option value="all">All Pages</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div id="export-img-range-row" class="hidden">
            <label class="bates-label" for="export-img-range">Page Range (e.g. 1-5, 8)</label>
            <input type="text" id="export-img-range" class="bates-field" placeholder="1-5, 8, 10-12">
          </div>
          <div class="modal-form-grid">
            <div>
              <label class="bates-label" for="export-img-format">Format</label>
              <select id="export-img-format" class="bates-field" aria-label="Export Img Format">
                <option value="png">PNG</option>
                <option value="jpg">JPEG</option>
              </select>
            </div>
            <div>
              <label class="bates-label" for="export-img-dpi">DPI</label>
              <select id="export-img-dpi" class="bates-field" aria-label="Export Img Dpi">
                <option value="72">72 (Screen)</option>
                <option value="150" selected>150 (Standard)</option>
                <option value="300">300 (Print)</option>
                <option value="600">600 (High Quality)</option>
              </select>
            </div>
          </div>
          <div id="export-img-quality-row">
            <label class="bates-label" for="export-img-quality">JPEG Quality</label>
            <input type="range" id="export-img-quality" min="50" max="100" value="92" class="w-full" aria-label="Export Img Quality">
            <span id="export-img-quality-val" class="range-value-label">92%</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="export-image">Cancel</button>
        <button class="btn-primary" id="btn-export-image-execute">Export</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Create PDF from Images Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="create-from-images-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Create PDF from Images">
    <div class="modal modal-w480">
      <div class="modal-header">
        <h2>Create PDF from Images</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="create-from-images">&times;</button>
      </div>
      <div class="modal-body">
        <div id="images-drop-zone" class="modal-drop-zone modal-form-section">
          <p>Drop image files here or click to add</p>
          <p class="drop-hint">PNG, JPEG, GIF, WebP</p>
          <input type="file" id="images-file-input" accept="image/*" multiple hidden aria-label="Images File Input">
        </div>
        <ul class="file-list" id="images-file-list"></ul>
        <div class="modal-form-grid mt-12">
          <div>
            <label class="bates-label" for="images-page-size">Page Size</label>
            <select id="images-page-size" class="bates-field" aria-label="Images Page Size">
              <option value="fit">Fit to Image</option>
              <option value="letter">Letter (8.5 x 11)</option>
              <option value="a4">A4</option>
              <option value="legal">Legal</option>
            </select>
          </div>
          <div>
            <label class="bates-label" for="images-margin">Margin (pt)</label>
            <input type="number" id="images-margin" class="bates-field" value="0" min="0" max="144" aria-label="Images Margin">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="create-from-images">Cancel</button>
        <button class="btn-primary" id="btn-create-from-images-execute" disabled>Create PDF</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Optimize PDF Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="optimize-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Optimize PDF">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2>Optimize PDF</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="optimize">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-form-grid">
          <div>
            <label class="bates-label" for="optimize-mode">Mode</label>
            <select id="optimize-mode" class="bates-field" aria-label="Optimize Mode">
              <option value="smart" selected>Smart â€” preserve text, compress images</option>
              <option value="images">Images Only â€” recompress embedded images</option>
              <option value="aggressive">Aggressive â€” rasterize all pages</option>
            </select>
          </div>
          <div>
            <label class="bates-label" for="optimize-preset">Preset</label>
            <select id="optimize-preset" class="bates-field" aria-label="Optimize Preset">
              <option value="screen">Screen (72 DPI, smaller file)</option>
              <option value="ebook" selected>eBook (150 DPI, balanced)</option>
              <option value="print">Print (200 DPI, higher quality)</option>
              <option value="prepress">Prepress (300 DPI, max quality)</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
        <div id="optimize-custom-opts" class="modal-form-grid hidden mt-8">
          <div>
            <label class="bates-label" for="optimize-dpi">DPI</label>
            <select id="optimize-dpi" class="bates-field" aria-label="Optimize Dpi">
              <option value="72">72</option>
              <option value="100">100</option>
              <option value="150" selected>150</option>
              <option value="200">200</option>
              <option value="300">300</option>
            </select>
          </div>
          <div>
            <label class="bates-label" for="optimize-quality">JPEG Quality</label>
            <input type="range" id="optimize-quality" min="30" max="95" value="75" class="w-full" aria-label="Optimize Quality">
            <span id="optimize-quality-val" class="range-value-label">75%</span>
          </div>
        </div>
        <p id="optimize-mode-hint" class="modal-form-hint mt-8">
          Smart mode preserves text, links, and fonts on text-only pages. Only image-heavy pages are recompressed.
        </p>
        <div id="optimize-result" class="hidden modal-preview-box mt-16 modal-text-sm"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="optimize">Cancel</button>
        <button class="btn-primary" id="btn-optimize-execute">Optimize</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Document Compare Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="compare-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Compare Documents">
    <div class="modal-panel modal-xl">
      <div class="modal-header">
        <h2>Compare Documents</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="compare">&times;</button>
      </div>
      <div class="modal-body">
        <!-- File selection (shown first) -->
        <div id="compare-setup">
          <p class="modal-form-hint">
            Compare the current document with another PDF to see differences.
          </p>
          <div id="compare-drop-zone" class="modal-drop-zone">
            <p>Drop the second PDF here or click to select</p>
            <input type="file" id="compare-file-input" accept=".pdf" hidden aria-label="Compare File Input">
          </div>
          <div class="modal-form-grid mt-12">
            <div>
              <label class="bates-label" for="compare-dpi">Comparison DPI</label>
              <select id="compare-dpi" class="bates-field" aria-label="Compare Dpi">
                <option value="72">72 (Fast)</option>
                <option value="96" selected>96 (Default)</option>
                <option value="150">150 (Detailed)</option>
              </select>
            </div>
            <div>
              <label class="bates-label" for="compare-threshold">Sensitivity</label>
              <select id="compare-threshold" class="bates-field" aria-label="Compare Threshold">
                <option value="15">High (15)</option>
                <option value="30" selected>Normal (30)</option>
                <option value="50">Low (50)</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Results (shown after comparison) -->
        <div id="compare-results" class="hidden">
          <div class="compare-results-header">
            <div id="compare-summary" class="modal-form-hint mb-0"></div>
            <div class="compare-nav">
              <select id="compare-view-mode" class="bates-field w-auto" aria-label="Compare View Mode">
                <option value="side-by-side">Side by Side</option>
                <option value="overlay">Overlay</option>
                <option value="diff-only">Diff Only</option>
              </select>
              <button class="btn-secondary btn-sm" id="btn-compare-prev" disabled>&larr; Prev</button>
              <span id="compare-page-info" class="compare-page-info">Page 1</span>
              <button class="btn-secondary btn-sm" id="btn-compare-next" disabled>Next &rarr;</button>
            </div>
          </div>
          <div id="compare-view" class="compare-view-area"></div>
          <pre id="compare-report" class="hidden modal-preview-box modal-report-pre"></pre>
        </div>
        <!-- Progress -->
        <div id="compare-progress" class="hidden mt-12">
          <div class="modal-progress-header">
            <span id="compare-progress-label">Comparing...</span>
            <span id="compare-progress-pct">0%</span>
          </div>
          <div class="modal-progress-bar-wrapper">
            <div id="compare-progress-bar" class="modal-progress-bar-fill" style="width:0%;"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary hidden" id="btn-compare-report">View Report</button>
        <button class="btn-secondary" data-close-modal="compare">Close</button>
        <button class="btn-primary" id="btn-compare-execute" disabled>Compare</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Comment Summary Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="comment-summary-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Comment Summary">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2>Annotation Summary</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="comment-summary">&times;</button>
      </div>
      <div class="modal-body">
        <div id="comment-summary-stats" class="modal-stat-grid">
          <div class="modal-stat-card">
            <div id="comment-stat-total" class="modal-stat-value">0</div>
            <div class="modal-stat-label">Total Annotations</div>
          </div>
          <div class="modal-stat-card">
            <div id="comment-stat-pages" class="modal-stat-value">0</div>
            <div class="modal-stat-label">Pages With Annotations</div>
          </div>
          <div class="modal-stat-card">
            <div id="comment-stat-types" class="modal-stat-value">0</div>
            <div class="modal-stat-label">Annotation Types</div>
          </div>
        </div>
        <div class="modal-form-section">
          <label class="bates-label" for="comment-export-format">Export Format</label>
          <select id="comment-export-format" class="bates-field w-auto" aria-label="Comment Export Format">
            <option value="text">Plain Text</option>
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
        </div>
        <pre id="comment-summary-preview" class="comment-summary-preview"></pre>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary btn-danger-text" id="btn-flatten-anno-exec">Flatten All</button>
        <button class="btn-secondary" data-close-modal="comment-summary">Close</button>
        <button class="btn-primary" id="btn-comment-download">Download</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Form Data Import/Export Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="form-data-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Import/Export Form Data">
    <div class="modal modal-w420">
      <div class="modal-header">
        <h2 id="form-data-modal-title">Form Data</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="form-data">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Import pane -->
        <div id="form-import-pane" class="hidden">
          <p class="modal-form-hint">
            Import form data from a JSON, XFDF, or CSV file.
          </p>
          <div id="form-import-drop-zone" class="modal-drop-zone">
            <p>Drop file here or click to select</p>
            <p class="drop-hint">JSON, XFDF, or CSV</p>
            <input type="file" id="form-import-file-input" accept=".json,.xfdf,.csv" hidden aria-label="Form Import File Input">
          </div>
          <div id="form-import-preview" class="hidden modal-preview-box mt-12 modal-text-xs modal-scrollable-list-sm"></div>
        </div>
        <!-- Export pane -->
        <div id="form-export-pane" class="hidden">
          <p class="modal-form-hint">
            Export current form data to a file.
          </p>
          <label class="bates-label" for="form-export-format">Format</label>
          <select id="form-export-format" class="bates-field" aria-label="Form Export Format">
            <option value="json">JSON</option>
            <option value="xfdf">XFDF (Adobe Compatible)</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="form-data">Cancel</button>
        <button class="btn-primary" id="btn-form-data-execute">Execute</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Exhibit Stamp Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="exhibit-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Exhibit Stamps">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2>Exhibit Stamp</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="exhibit">&times;</button>
      </div>
      <div class="modal-body">
        <label class="bates-label" for="exhibit-format">Numbering Format</label>
        <select id="exhibit-format" class="bates-field" aria-label="Exhibit Format">
          <option value="letter">A, B, C...</option>
          <option value="number">1, 2, 3...</option>
          <option value="roman-upper">I, II, III...</option>
          <option value="roman-lower">i, ii, iii...</option>
        </select>
        <label class="bates-label mt-12" for="exhibit-prefix">Prefix (optional)</label>
        <input type="text" id="exhibit-prefix" class="bates-field" placeholder="e.g. Plaintiff's ">
        <label class="modal-checkbox-list mt-12">
          <label><input type="checkbox" id="exhibit-include-date" checked aria-label="Exhibit Include Date"> Include date on stamp</label>
        </label>
        <div class="modal-preview-box exhibit-preview-box">
          <p class="modal-preview-title">Preview</p>
          <div id="exhibit-preview" class="exhibit-preview-text">EXHIBIT A</div>
        </div>
        <p class="modal-muted-hint">
          Click anywhere on the page to place the exhibit stamp. Numbers auto-increment.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="exhibit">Cancel</button>
        <button class="btn-primary" id="btn-exhibit-execute">Place Stamp</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Sanitize Document Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="sanitize-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Sanitize Document">
    <div class="modal modal-w440">
      <div class="modal-header">
        <h2>Sanitize Document</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="sanitize">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Remove all hidden data before filing or sharing. This will strip:
        </p>
        <div class="modal-info-box">
          <ul>
            <li>Document title, author, subject, keywords</li>
            <li>Creator and producer software tags</li>
            <li>Creation and modification dates</li>
            <li>Revision history and XMP metadata</li>
          </ul>
        </div>
        <div class="modal-checkbox-list mt-16">
          <label><input type="checkbox" id="sanitize-confirm" aria-label="Sanitize Confirm"> I understand this cannot be undone</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="sanitize">Cancel</button>
        <button class="btn-primary" id="btn-sanitize-execute" disabled>Sanitize Document</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Page Labels Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-labels-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Page Labels">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2>Page Labels</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="page-labels">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Define custom numbering for different document sections (e.g. roman numerals for front matter).
        </p>
        <div id="page-labels-list" class="page-labels-list">
          <!-- Rows added dynamically -->
        </div>
        <button id="btn-add-label-range" class="btn-secondary btn-full mt-12">+ Add Range</button>
        <div class="modal-preview-box mt-12 modal-scrollable-list-xs">
          <p class="modal-preview-title">Preview</p>
          <div id="page-labels-preview" class="page-labels-preview"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="page-labels">Cancel</button>
        <button class="btn-primary" id="btn-page-labels-apply">Apply Labels</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Replace Pages Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="replace-pages-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Replace Pages">
    <div class="modal modal-w560">
      <div class="modal-header">
        <h2>Replace Pages</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="replace-pages">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-form-hint">
          Replace pages in the current document with pages from another PDF.
        </p>
        <div id="replace-source-drop" class="modal-drop-zone">
          <p>Click to choose source PDF</p>
          <p class="drop-hint">or drag and drop</p>
          <input type="file" id="replace-file-input" accept=".pdf" hidden aria-label="Replace File Input">
        </div>
        <div id="replace-mapping" class="hidden mt-16">
          <p class="modal-form-hint mb-8">
            Source: <strong id="replace-source-name"></strong> (<span id="replace-source-pages"></span> pages)
          </p>
          <div class="replace-table-wrap">
            <table class="replace-table">
              <thead>
                <tr>
                  <th>Current Page</th>
                  <th>Replace With</th>
                </tr>
              </thead>
              <tbody id="replace-mappings-list"></tbody>
            </table>
          </div>
          <div class="modal-checkbox-list mt-12 modal-muted-hint">
            <label><input type="checkbox" id="replace-confirm" aria-label="Replace Confirm"> I understand replaced pages cannot be recovered</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close-modal="replace-pages">Cancel</button>
        <button class="btn-primary" id="btn-replace-execute" disabled>Replace Pages</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for creating PDF from images -->
  <input type="file" id="create-images-file-input" accept="image/*" multiple hidden aria-label="Create Images File Input">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Keyboard Shortcuts Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="shortcuts-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="Keyboard Shortcuts">
    <div class="modal modal-w520">
      <div class="modal-header">
        <h2>Keyboard Shortcuts</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="shortcuts">&times;</button>
      </div>
      <div class="modal-body">
        <div class="shortcuts-grid">
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">File</h3>
            <div class="shortcut-row"><span>Open file</span><kbd>Ctrl+O</kbd></div>
            <div class="shortcut-row"><span>Export / Save</span><kbd>Ctrl+S</kbd></div>
            <div class="shortcut-row"><span>Print</span><kbd>Ctrl+P</kbd></div>
          </div>
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">Edit</h3>
            <div class="shortcut-row"><span>Undo</span><kbd>Ctrl+Z</kbd></div>
            <div class="shortcut-row"><span>Redo</span><kbd>Ctrl+Y</kbd></div>
            <div class="shortcut-row"><span>Find in PDF</span><kbd>Ctrl+F</kbd></div>
            <div class="shortcut-row"><span>Delete selection</span><kbd>Delete</kbd></div>
          </div>
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">Tools</h3>
            <div class="shortcut-row"><span>Select tool</span><kbd>V</kbd></div>
            <div class="shortcut-row"><span>Hand / Pan</span><kbd>H</kbd></div>
            <div class="shortcut-row"><span>Text tool</span><kbd>T</kbd></div>
            <div class="shortcut-row"><span>Draw tool</span><kbd>D</kbd></div>
          </div>
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">View</h3>
            <div class="shortcut-row"><span>Zoom in</span><kbd>+</kbd></div>
            <div class="shortcut-row"><span>Zoom out</span><kbd>âˆ’</kbd></div>
            <div class="shortcut-row"><span>Previous page</span><kbd>Ctrl+[</kbd></div>
            <div class="shortcut-row"><span>Next page</span><kbd>Ctrl+]</kbd></div>
          </div>
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">Text Editing</h3>
            <div class="shortcut-row"><span>Bold</span><kbd>Ctrl+B</kbd></div>
            <div class="shortcut-row"><span>Italic</span><kbd>Ctrl+I</kbd></div>
            <div class="shortcut-row"><span>Undo edit</span><kbd>Ctrl+Z</kbd></div>
            <div class="shortcut-row"><span>Redo edit</span><kbd>Ctrl+Y</kbd></div>
            <div class="shortcut-row"><span>Apply changes</span><kbd>Ctrl+Enter</kbd></div>
          </div>
          <div class="shortcuts-section">
            <h3 class="shortcuts-section-title">General</h3>
            <div class="shortcut-row"><span>Show shortcuts</span><kbd>?</kbd></div>
            <div class="shortcut-row"><span>Close modal / Deselect</span><kbd>Esc</kbd></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• About Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="about-modal-backdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-label="About Mudbrick">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2>About Mudbrick</h2>
        <button type="button" class="modal-close" aria-label="Close" data-close-modal="about">&times;</button>
      </div>
      <div class="modal-body modal-body-centered">
        <div class="about-emoji">ðŸ§±</div>
        <h3 class="about-title">Mudbrick</h3>
        <p class="about-subtitle">Free, open-source PDF editor</p>
        <p class="about-body">
          No subscription. No dark patterns.<br>
          Runs entirely in your browser.<br>
          Your files never leave your device.
        </p>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Service Worker Registration â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => {
            console.log('SW registered:', reg.scope);
            reg.onupdatefound = () => {
              const newWorker = reg.installing;
              if (!newWorker) return;
              newWorker.onstatechange = () => {
                if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                  // New version available â€” show refresh hint
                  const banner = document.createElement('div');
                  banner.style.cssText = 'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--mb-accent);color:#fff;padding:10px 20px;border-radius:8px;z-index:9999;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;';
                  banner.innerHTML = '<span>A new version is available.</span><button onclick="location.reload()" style="background:#fff;color:var(--mb-accent);border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-weight:600;">Refresh</button><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;">&times;</button>';
                  document.body.appendChild(banner);
                }
              };
            };
          })
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• App Entry Point (ES Module) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script type="module" src="js/app.js"></script>

</body>
</html>
